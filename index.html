<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Ticketing System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icon component that works with Lucide
        function Icon({ name, size = 16 }) {
            useEffect(() => {
                lucide.createIcons();
            });
            return <i data-lucide={name} style={{ width: size, height: size }}></i>;
        }

        function TicketingSystem() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [tickets, setTickets] = useState([]);
            const [archivedTickets, setArchivedTickets] = useState([]);
            const [recycleBin, setRecycleBin] = useState([]);
            const [invoices, setInvoices] = useState([]);
            const [showNewTicket, setShowNewTicket] = useState(false);
            const [showNewInvoice, setShowNewInvoice] = useState(false);
            const [newTicket, setNewTicket] = useState({ 
                client: '', 
                description: '', 
                priority: 'amber',
                urgency: 'medium',
                assignedTo: '',
                dateSent: '',
                deadline: ''
            });
            const [newInvoice, setNewInvoice] = useState({
                client: '',
                clientEmail: '',
                clientPhone: '',
                hours: '',
                cost: '',
                jobDescription: '',
                jobDate: '',
                assignedTo: '',
                chargeTiming: 'now',
                quickbooks: false,
                paid: false
            });
            const [currentView, setCurrentView] = useState('dashboard');
            const [viewArchived, setViewArchived] = useState(false);
            const [viewRecycleBin, setViewRecycleBin] = useState(false);
            const [editingTicket, setEditingTicket] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [editingInvoice, setEditingInvoice] = useState(null);
            const [invoiceEditForm, setInvoiceEditForm] = useState({});
            const [settingsTab, setSettingsTab] = useState('account');
            const [theme, setTheme] = useState('serenity-blue');
            const [darkMode, setDarkMode] = useState(false);
            
            // New mega features states
            const [invoiceRecycleBin, setInvoiceRecycleBin] = useState([]);
            const [viewInvoiceRecycleBin, setViewInvoiceRecycleBin] = useState(false);
            const [showReceipt, setShowReceipt] = useState(null);
            const [ticketSortBy, setTicketSortBy] = useState('date');
            const [invoiceGroupBy, setInvoiceGroupBy] = useState('all');
            const [ticketGroupBy, setTicketGroupBy] = useState('all');
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [showWelcome, setShowWelcome] = useState(true);
            const [viewMyTickets, setViewMyTickets] = useState(false);
            const [invoiceFilter, setInvoiceFilter] = useState('all'); // all, paid, unpaid
            
            const [passwordChange, setPasswordChange] = useState({ current: '', new: '', confirm: '' });
            const [emailEdit, setEmailEdit] = useState('');
            const [isEditingEmail, setIsEditingEmail] = useState(false);
            const [selectedUserForAdmin, setSelectedUserForAdmin] = useState(null);
            const [resetPasswordInputs, setResetPasswordInputs] = useState({});
            
            const [users, setUsers] = useState([
                { id: 1, username: 'admin', password: 'admin123', role: 'admin', email: 'admin@example.com', active: true },
                { id: 2, username: 'user', password: 'user123', role: 'user', email: 'user@example.com', active: true }
            ]);
            
            const [staffMembers, setStaffMembers] = useState([]);
            
            const [showAddStaffModal, setShowAddStaffModal] = useState(false);
            const [newStaffMember, setNewStaffMember] = useState({ name: '', username: '', password: '' });

            useEffect(() => {
                lucide.createIcons();
            });

            useEffect(() => {
                if (isLoggedIn) {
                    // Start with no tickets - ready for client
                    setTickets([]);
                }
            }, [isLoggedIn]);

            // Create/update workload pie chart
            useEffect(() => {
                if (settingsTab === 'workload' && currentView === 'settings') {
                    setTimeout(() => {
                        const canvas = document.getElementById('workloadChart');
                        if (!canvas) return;

                        const ctx = canvas.getContext('2d');
                        
                        // Calculate workload data
                        const workloadData = {};
                        tickets.forEach(ticket => {
                            workloadData[ticket.assignedTo] = (workloadData[ticket.assignedTo] || 0) + 1;
                        });

                        const labels = Object.keys(workloadData);
                        const data = Object.values(workloadData);
                        
                        // Generate colors
                        const colors = [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                            '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#84CC16'
                        ];

                        // Destroy existing chart if any
                        if (window.workloadChartInstance) {
                            window.workloadChartInstance.destroy();
                        }

                        // Create new chart
                        if (labels.length > 0) {
                            window.workloadChartInstance = new Chart(ctx, {
                                type: 'pie',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        data: data,
                                        backgroundColor: colors.slice(0, labels.length),
                                        borderWidth: 2,
                                        borderColor: '#ffffff'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: {
                                                padding: 15,
                                                font: {
                                                    size: 12
                                                }
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const label = context.label || '';
                                                    const value = context.parsed || 0;
                                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                    const percentage = ((value / total) * 100).toFixed(1);
                                                    return `${label}: ${value} tickets (${percentage}%)`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                }
            }, [settingsTab, currentView, tickets]);

            const handleLogin = () => {
                const user = users.find(u => u.username === loginForm.username && u.password === loginForm.password);
                if (user) {
                    setCurrentUser(user);
                    setIsLoggedIn(true);
                } else {
                    alert('Invalid credentials');
                }
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                setCurrentUser(null);
            };

            const createTicket = () => {
                if (!newTicket.client || !newTicket.description || !newTicket.assignedTo) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Set dateSent to today if not provided
                const dateSent = newTicket.dateSent || new Date().toISOString().split('T')[0];
                
                setTickets([{
                    id: Date.now(),
                    ...newTicket,
                    dateSent: dateSent,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString(),
                    completed: false
                }, ...tickets]);
                setNewTicket({ 
                    client: '', 
                    description: '', 
                    priority: 'amber', 
                    urgency: 'medium',
                    assignedTo: '',
                    dateSent: '',
                    deadline: ''
                });
                setShowNewTicket(false);
            };

            const createInvoice = () => {
                if (!newInvoice.client || !newInvoice.hours || !newInvoice.cost) {
                    alert('Please fill in required fields');
                    return;
                }
                setInvoices([{
                    id: Date.now(),
                    ...newInvoice,
                    totalCost: parseFloat(newInvoice.hours) * parseFloat(newInvoice.cost),
                    createdAt: new Date().toISOString()
                }, ...invoices]);
                setNewInvoice({
                    client: '', 
                    clientEmail: '', 
                    clientPhone: '', 
                    hours: '', 
                    cost: '', 
                    jobDescription: '', 
                    jobDate: '', 
                    assignedTo: '', 
                    chargeTiming: 'now', 
                    quickbooks: false, 
                    paid: false
                });
                setShowNewInvoice(false);
            };

            const toggleInvoicePaid = (id) => {
                setInvoices(invoices.map(inv => 
                    inv.id === id ? { ...inv, paid: !inv.paid } : inv
                ));
            };

            const deleteInvoice = (id) => {
                if (window.confirm('Move this invoice to Recycle Bin?')) {
                    const invoice = invoices.find(i => i.id === id);
                    if (invoice) {
                        setInvoiceRecycleBin([...invoiceRecycleBin, { ...invoice, deletedAt: new Date().toISOString() }]);
                        setInvoices(invoices.filter(i => i.id !== id));
                    }
                }
            };

            const restoreInvoice = (id) => {
                const invoice = invoiceRecycleBin.find(i => i.id === id);
                if (invoice) {
                    const { deletedAt, ...restoredInvoice } = invoice;
                    setInvoices([...invoices, restoredInvoice]);
                    setInvoiceRecycleBin(invoiceRecycleBin.filter(i => i.id !== id));
                }
            };

            const permanentlyDeleteInvoice = (id) => {
                if (window.confirm('Permanently delete this invoice? This cannot be undone!')) {
                    setInvoiceRecycleBin(invoiceRecycleBin.filter(i => i.id !== id));
                }
            };

            const startEditInvoice = (invoice) => {
                setEditingInvoice(invoice.id);
                setInvoiceEditForm({ ...invoice });
            };

            const saveInvoiceEdit = (id) => {
                // Recalculate total cost if hours or cost changed
                const updatedInvoice = {
                    ...invoiceEditForm,
                    totalCost: parseFloat(invoiceEditForm.hours) * parseFloat(invoiceEditForm.cost)
                };
                setInvoices(invoices.map(inv => inv.id === id ? updatedInvoice : inv));
                setEditingInvoice(null);
            };

            const startEdit = (ticket) => {
                setEditingTicket(ticket.id);
                setEditForm({ ...ticket });
            };

            const saveEdit = (id) => {
                setTickets(tickets.map(t => t.id === id ? { ...t, ...editForm } : t));
                setEditingTicket(null);
            };

            const deleteTicket = (id) => {
                if (window.confirm('Move this ticket to Recycle Bin?')) {
                    const ticket = tickets.find(t => t.id === id);
                    if (ticket) {
                        setRecycleBin([...recycleBin, { ...ticket, deletedAt: new Date().toISOString(), deletedFrom: 'active' }]);
                        setTickets(tickets.filter(t => t.id !== id));
                    }
                }
            };

            const markComplete = (id) => {
                const ticket = tickets.find(t => t.id === id);
                if (ticket && !ticket.completed) {
                    // Mark as complete and auto-archive
                    const completedTicket = { ...ticket, completed: true, completedAt: new Date().toISOString() };
                    setArchivedTickets([...archivedTickets, { ...completedTicket, archivedAt: new Date().toISOString() }]);
                    setTickets(tickets.filter(t => t.id !== id));
                }
            };

            const archiveTicket = (id) => {
                const ticket = tickets.find(t => t.id === id);
                if (ticket) {
                    setArchivedTickets([...archivedTickets, { ...ticket, archivedAt: new Date().toISOString() }]);
                    setTickets(tickets.filter(t => t.id !== id));
                }
            };

            const unarchiveTicket = (id) => {
                const ticket = archivedTickets.find(t => t.id === id);
                if (ticket) {
                    // Remove archived metadata and reset completed status
                    const { archivedAt, completedAt, completed, ...ticketData } = ticket;
                    const reopenedTicket = { ...ticketData, completed: false };
                    setTickets([reopenedTicket, ...tickets]);
                    setArchivedTickets(archivedTickets.filter(t => t.id !== id));
                }
            };

            const deleteArchivedTicket = (id) => {
                if (window.confirm('Move this ticket to Recycle Bin?')) {
                    const ticket = archivedTickets.find(t => t.id === id);
                    if (ticket) {
                        setRecycleBin([...recycleBin, { ...ticket, deletedAt: new Date().toISOString(), deletedFrom: 'archived' }]);
                        setArchivedTickets(archivedTickets.filter(t => t.id !== id));
                    }
                }
            };

            const restoreFromBin = (id) => {
                const ticket = recycleBin.find(t => t.id === id);
                if (ticket) {
                    const { deletedAt, deletedFrom, ...ticketData } = ticket;
                    if (deletedFrom === 'archived') {
                        setArchivedTickets([...archivedTickets, ticketData]);
                    } else {
                        setTickets([...tickets, ticketData]);
                    }
                    setRecycleBin(recycleBin.filter(t => t.id !== id));
                }
            };

            const permanentDelete = (id) => {
                if (window.confirm('Permanently delete this ticket? This cannot be undone!')) {
                    setRecycleBin(recycleBin.filter(t => t.id !== id));
                }
            };

            const emptyRecycleBin = () => {
                if (window.confirm(`Permanently delete all ${recycleBin.length} tickets? This cannot be undone!`)) {
                    setRecycleBin([]);
                }
            };

            const addStaffMember = () => {
                if (!newStaffMember.name.trim() || !newStaffMember.username.trim() || !newStaffMember.password.trim()) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Check if username already exists
                if (users.find(u => u.username === newStaffMember.username)) {
                    alert('Username already exists');
                    return;
                }
                
                // Add to staff members list
                setStaffMembers([...staffMembers, newStaffMember.name.trim()]);
                
                // Create user account for the staff member
                const newUserAccount = {
                    id: Date.now(),
                    username: newStaffMember.username.trim(),
                    password: newStaffMember.password,
                    email: `${newStaffMember.username.trim()}@company.com`,
                    role: 'user',
                    active: true
                };
                setUsers([...users, newUserAccount]);
                
                // Reset form
                setNewStaffMember({ name: '', username: '', password: '' });
                setShowAddStaffModal(false);
                
                alert(`Staff member added!\nName: ${newStaffMember.name}\nUsername: ${newStaffMember.username}\nPassword: ${newStaffMember.password}\n\nThey can now login with these credentials.`);
            };

            const changePassword = () => {
                if (!passwordChange.current || !passwordChange.new || !passwordChange.confirm) {
                    alert('Please fill in all fields');
                    return;
                }
                
                if (currentUser.password !== passwordChange.current) {
                    alert('Current password is incorrect');
                    return;
                }
                
                if (passwordChange.new !== passwordChange.confirm) {
                    alert('New passwords do not match');
                    return;
                }
                
                if (passwordChange.new.length < 6) {
                    alert('New password must be at least 6 characters');
                    return;
                }
                
                // Update password in users array
                setUsers(users.map(u => 
                    u.id === currentUser.id ? { ...u, password: passwordChange.new } : u
                ));
                
                // Update current user
                setCurrentUser({ ...currentUser, password: passwordChange.new });
                
                // Reset form
                setPasswordChange({ current: '', new: '', confirm: '' });
                
                alert('Password changed successfully!');
            };

            const saveEmail = () => {
                if (!emailEdit.trim()) {
                    alert('Email cannot be empty');
                    return;
                }
                
                // Basic email validation
                if (!emailEdit.includes('@')) {
                    alert('Please enter a valid email address');
                    return;
                }
                
                // Update email in users array
                setUsers(users.map(u => 
                    u.id === currentUser.id ? { ...u, email: emailEdit } : u
                ));
                
                // Update current user
                setCurrentUser({ ...currentUser, email: emailEdit });
                
                setIsEditingEmail(false);
                alert('Email updated successfully!');
            };

            const adminResetUserPassword = (userId, newPassword) => {
                if (!newPassword || newPassword.length < 6) {
                    alert('Password must be at least 6 characters');
                    return;
                }
                
                setUsers(users.map(u => 
                    u.id === userId ? { ...u, password: newPassword } : u
                ));
                
                // Clear the input
                setResetPasswordInputs(prev => ({ ...prev, [userId]: '' }));
                
                alert('Password reset successfully!');
            };

            const adminChangeUserRole = (userId, newRole) => {
                setUsers(users.map(u => 
                    u.id === userId ? { ...u, role: newRole } : u
                ));
                
                alert(`Role changed to ${newRole} successfully!`);
            };

            const formatDateTime = (dateString) => {
                const date = new Date(dateString);
                return {
                    date: date.toLocaleDateString('en-GB'),
                    time: date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })
                };
            };

            const getPriorityColor = (priority) => {
                const colors = { red: 'bg-red-500', amber: 'bg-amber-500', green: 'bg-green-500' };
                return colors[priority] || 'bg-gray-500';
            };

            const getUrgencyColor = (urgency) => {
                const colors = { high: 'bg-red-500', medium: 'bg-amber-500', low: 'bg-green-500' };
                return colors[urgency] || 'bg-gray-500';
            };

            const getUrgencyLabel = (urgency) => {
                const labels = { high: 'High', medium: 'Medium', low: 'Low' };
                return labels[urgency] || 'Unknown';
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(amount);
            };

            // Mega features helper functions
            
            // Get overdue tickets
            const getOverdueTickets = () => {
                const today = new Date().toISOString().split('T')[0];
                return tickets.filter(t => t.deadline && t.deadline < today && !t.completed);
            };

            // Get tickets due today
            const getTicketsDueToday = () => {
                const today = new Date().toISOString().split('T')[0];
                return tickets.filter(t => t.deadline === today && !t.completed);
            };

            // Get open tickets (not completed, no deadline or future deadline)
            const getOpenTickets = () => {
                const today = new Date().toISOString().split('T')[0];
                return tickets.filter(t => !t.completed && (!t.deadline || t.deadline >= today));
            };

            // Get tickets near deadline (within 3 days)
            const getTicketsNearDeadline = () => {
                const today = new Date();
                const threeDaysFromNow = new Date(today);
                threeDaysFromNow.setDate(today.getDate() + 3);
                const todayStr = today.toISOString().split('T')[0];
                const threeDaysStr = threeDaysFromNow.toISOString().split('T')[0];
                
                return tickets.filter(t => 
                    t.deadline && 
                    t.deadline >= todayStr && 
                    t.deadline <= threeDaysStr && 
                    !t.completed
                );
            };

            // Get monthly revenue
            const getMonthlyRevenue = (month, year) => {
                return invoices
                    .filter(inv => {
                        if (!inv.jobDate) return false;
                        const invDate = new Date(inv.jobDate);
                        return invDate.getMonth() === month && invDate.getFullYear() === year;
                    })
                    .reduce((sum, inv) => sum + (inv.totalCost || 0), 0);
            };

            // Get total revenue for year
            const getYearlyRevenue = (year) => {
                return invoices
                    .filter(inv => {
                        if (!inv.jobDate) return false;
                        return new Date(inv.jobDate).getFullYear() === year;
                    })
                    .reduce((sum, inv) => sum + (inv.totalCost || 0), 0);
            };

            // Group invoices by month
            const groupInvoicesByMonth = () => {
                const grouped = {};
                invoices.forEach(inv => {
                    if (inv.jobDate) {
                        const date = new Date(inv.jobDate);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (!grouped[monthKey]) {
                            grouped[monthKey] = [];
                        }
                        grouped[monthKey].push(inv);
                    }
                });
                return grouped;
            };

            // Group tickets by month
            const groupTicketsByMonth = () => {
                const grouped = {};
                tickets.forEach(ticket => {
                    if (ticket.dateSent) {
                        const date = new Date(ticket.dateSent);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (!grouped[monthKey]) {
                            grouped[monthKey] = [];
                        }
                        grouped[monthKey].push(ticket);
                    }
                });
                return grouped;
            };

            // Sort tickets by urgency
            const sortTicketsByUrgency = (ticketsList) => {
                const urgencyOrder = { high: 3, medium: 2, low: 1 };
                return [...ticketsList].sort((a, b) => 
                    (urgencyOrder[b.urgency] || 0) - (urgencyOrder[a.urgency] || 0)
                );
            };

            // Get user's assigned tickets
            const getMyTickets = () => {
                return tickets.filter(t => t.assignedTo === currentUser.username);
            };

            // Get month name
            const getMonthName = (monthKey) => {
                const [year, month] = monthKey.split('-');
                const date = new Date(year, parseInt(month) - 1);
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            };

            // Get theme colors based on selected theme
            const getThemeColors = () => {
                const themes = {
                    'serenity-blue': {
                        primary: 'bg-blue-500',
                        primaryHover: 'hover:bg-blue-600',
                        primaryText: 'text-blue-600',
                        primaryBg: 'bg-gradient-to-br from-blue-100 via-cyan-50 to-blue-50',
                        primaryBorder: 'border-blue-500',
                        gradient: 'from-blue-400 via-cyan-300 to-blue-200',
                        headerGradient: 'bg-gradient-to-r from-blue-500 via-cyan-400 to-blue-400',
                        cardGradient: 'bg-gradient-to-br from-blue-50 to-cyan-50'
                    },
                    'forest-dreams': {
                        primary: 'bg-green-600',
                        primaryHover: 'hover:bg-green-700',
                        primaryText: 'text-green-700',
                        primaryBg: 'bg-gradient-to-br from-green-100 via-emerald-50 to-teal-50',
                        primaryBorder: 'border-green-600',
                        gradient: 'from-green-400 via-emerald-300 to-teal-300',
                        headerGradient: 'bg-gradient-to-r from-green-600 via-emerald-500 to-teal-500',
                        cardGradient: 'bg-gradient-to-br from-green-50 to-emerald-50'
                    },
                    'pastel-paradise': {
                        primary: 'bg-pink-500',
                        primaryHover: 'hover:bg-pink-600',
                        primaryText: 'text-pink-600',
                        primaryBg: 'bg-gradient-to-br from-pink-100 via-purple-50 to-blue-50',
                        primaryBorder: 'border-pink-500',
                        gradient: 'from-pink-300 via-purple-200 to-blue-200',
                        headerGradient: 'bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400',
                        cardGradient: 'bg-gradient-to-br from-pink-50 to-purple-50'
                    },
                    'midnight-purple': {
                        primary: 'bg-purple-600',
                        primaryHover: 'hover:bg-purple-700',
                        primaryText: 'text-purple-700',
                        primaryBg: 'bg-gradient-to-br from-purple-100 via-indigo-50 to-violet-50',
                        primaryBorder: 'border-purple-600',
                        gradient: 'from-purple-500 via-indigo-400 to-violet-400',
                        headerGradient: 'bg-gradient-to-r from-purple-600 via-indigo-500 to-violet-500',
                        cardGradient: 'bg-gradient-to-br from-purple-50 to-indigo-50'
                    },
                    // Keep old themes for compatibility
                    blue: {
                        primary: 'bg-blue-600',
                        primaryHover: 'hover:bg-blue-700',
                        primaryText: 'text-blue-600',
                        primaryBg: 'bg-blue-50',
                        primaryBorder: 'border-blue-600',
                        gradient: 'from-blue-50 to-indigo-100',
                        headerGradient: 'bg-blue-600',
                        cardGradient: 'bg-white'
                    },
                    green: {
                        primary: 'bg-green-600',
                        primaryHover: 'hover:bg-green-700',
                        primaryText: 'text-green-600',
                        primaryBg: 'bg-green-50',
                        primaryBorder: 'border-green-600',
                        gradient: 'from-green-50 to-emerald-100',
                        headerGradient: 'bg-green-600',
                        cardGradient: 'bg-white'
                    },
                    purple: {
                        primary: 'bg-purple-600',
                        primaryHover: 'hover:bg-purple-700',
                        primaryText: 'text-purple-600',
                        primaryBg: 'bg-purple-50',
                        primaryBorder: 'border-purple-600',
                        gradient: 'from-purple-50 to-violet-100',
                        headerGradient: 'bg-purple-600',
                        cardGradient: 'bg-white'
                    },
                    orange: {
                        primary: 'bg-orange-600',
                        primaryHover: 'hover:bg-orange-700',
                        primaryText: 'text-orange-600',
                        primaryBg: 'bg-orange-50',
                        primaryBorder: 'border-orange-600',
                        gradient: 'from-orange-50 to-amber-100',
                        headerGradient: 'bg-orange-600',
                        cardGradient: 'bg-white'
                    }
                };
                return themes[theme] || themes['serenity-blue'];
            };

            const currentTheme = getThemeColors();

            // LOGIN SCREEN
            if (!isLoggedIn) {
                return (
                    <div className={`min-h-screen bg-gradient-to-br ${darkMode ? 'from-gray-900 to-gray-800' : currentTheme.gradient} flex items-center justify-center p-4`}>
                        <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow-xl p-8 w-full max-w-md`}>
                            <div className="text-center mb-8">
                                <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2`}>Ticketing System</h1>
                                <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Sign in to manage support tickets</p>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-1`}>Username</label>
                                    <input
                                        type="text"
                                        value={loginForm.username}
                                        onChange={(e) => setLoginForm({ ...loginForm, username: e.target.value })}
                                        className={`w-full px-4 py-2 border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-${theme}-500`}
                                    />
                                </div>
                                
                                <div>
                                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-1`}>Password</label>
                                    <input
                                        type="password"
                                        value={loginForm.password}
                                        onChange={(e) => setLoginForm({ ...loginForm, password: e.target.value })}
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                        className={`w-full px-4 py-2 border ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-${theme}-500`}
                                    />
                                </div>
                                
                                <button
                                    onClick={handleLogin}
                                    className={`w-full ${currentTheme.primary} ${currentTheme.primaryHover} text-white py-2 rounded-lg font-medium`}
                                >
                                    Sign In
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // WELCOME SCREEN
            if (showWelcome) {
                const overdueCount = getOverdueTickets().length;
                const dueTodayCount = getTicketsDueToday().length;
                const myTicketsCount = getMyTickets().length;
                const nearDeadlineCount = getTicketsNearDeadline().length;

                return (
                    <div className={`min-h-screen bg-gradient-to-br ${darkMode ? 'from-gray-900 via-gray-800 to-gray-900' : currentTheme.gradient} flex items-center justify-center p-4`}>
                        <div className={`${darkMode ? 'bg-gray-800/95 border border-gray-700' : 'bg-white/95'} backdrop-blur-sm rounded-2xl shadow-2xl p-8 md:p-12 w-full max-w-4xl`}>
                            <div className="text-center mb-8">
                                <div className="inline-block p-4 rounded-full bg-gradient-to-br ${currentTheme.gradient} mb-4">
                                    <Icon name="sparkles" size={48} className="text-white" />
                                </div>
                                <h1 className={`text-4xl md:text-5xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-3`}>
                                    Welcome back, {currentUser.username}! ðŸ‘‹
                                </h1>
                                <p className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                    Here's what's happening today
                                </p>
                            </div>

                            {/* Quick Stats Grid */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div className={`${darkMode ? 'bg-gray-700/50' : currentTheme.cardGradient} rounded-xl p-6 text-center border ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                                    <div className="text-3xl font-bold text-blue-600 mb-2">{myTicketsCount}</div>
                                    <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>My Tickets</div>
                                </div>
                                <div className={`${darkMode ? 'bg-gray-700/50' : currentTheme.cardGradient} rounded-xl p-6 text-center border ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                                    <div className="text-3xl font-bold text-yellow-600 mb-2">{dueTodayCount}</div>
                                    <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Due Today</div>
                                </div>
                                <div className={`${darkMode ? 'bg-gray-700/50' : currentTheme.cardGradient} rounded-xl p-6 text-center border ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                                    <div className="text-3xl font-bold text-red-600 mb-2">{overdueCount}</div>
                                    <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Overdue</div>
                                </div>
                                <div className={`${darkMode ? 'bg-gray-700/50' : currentTheme.cardGradient} rounded-xl p-6 text-center border ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                                    <div className="text-3xl font-bold text-orange-600 mb-2">{nearDeadlineCount}</div>
                                    <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Upcoming</div>
                                </div>
                            </div>

                            {/* Quick Actions */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                <button
                                    onClick={() => { setShowWelcome(false); setCurrentView('tickets'); setViewMyTickets(true); }}
                                    className={`${currentTheme.primary} ${currentTheme.primaryHover} text-white p-6 rounded-xl flex flex-col items-center gap-3 hover:scale-105 transition-transform shadow-lg`}
                                >
                                    <Icon name="clipboard-list" size={32} />
                                    <span className="font-semibold text-lg">My Tickets</span>
                                    <span className="text-sm opacity-90">{myTicketsCount} assigned to you</span>
                                </button>
                                <button
                                    onClick={() => { setShowWelcome(false); setCurrentView('dashboard'); }}
                                    className={`${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gradient-to-br from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300'} ${darkMode ? 'text-white' : 'text-gray-800'} p-6 rounded-xl flex flex-col items-center gap-3 hover:scale-105 transition-transform shadow-lg`}
                                >
                                    <Icon name="layout-dashboard" size={32} />
                                    <span className="font-semibold text-lg">Dashboard</span>
                                    <span className="text-sm opacity-75">View analytics</span>
                                </button>
                                <button
                                    onClick={() => { setShowWelcome(false); setCurrentView('tickets'); setShowNewTicket(true); }}
                                    className={`${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gradient-to-br from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300'} ${darkMode ? 'text-white' : 'text-gray-800'} p-6 rounded-xl flex flex-col items-center gap-3 hover:scale-105 transition-transform shadow-lg`}
                                >
                                    <Icon name="plus-circle" size={32} />
                                    <span className="font-semibold text-lg">New Ticket</span>
                                    <span className="text-sm opacity-75">Create ticket</span>
                                </button>
                            </div>

                            {/* Alerts */}
                            {(overdueCount > 0 || nearDeadlineCount > 0) && (
                                <div className={`${darkMode ? 'bg-red-900/30 border-red-700' : 'bg-red-50 border-red-200'} border rounded-xl p-4 mb-6`}>
                                    <div className="flex items-center gap-3">
                                        <Icon name="alert-circle" size={24} className="text-red-600" />
                                        <div>
                                            <div className={`font-semibold ${darkMode ? 'text-red-400' : 'text-red-800'}`}>Attention Needed!</div>
                                            <div className={`text-sm ${darkMode ? 'text-red-300' : 'text-red-700'}`}>
                                                {overdueCount > 0 && `${overdueCount} ticket${overdueCount > 1 ? 's' : ''} overdue. `}
                                                {nearDeadlineCount > 0 && `${nearDeadlineCount} ticket${nearDeadlineCount > 1 ? 's' : ''} due soon.`}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <button
                                onClick={() => setShowWelcome(false)}
                                className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'} py-3 rounded-xl font-medium transition-colors`}
                            >
                                Continue to Dashboard â†’
                            </button>
                        </div>
                    </div>
                );
            }

            const displayTickets = viewRecycleBin ? recycleBin : (viewArchived ? archivedTickets : tickets);

            // MAIN APP
            return (
                <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
                    {/* Header */}
                    <header className={`${darkMode ? 'bg-gray-800 border-gray-700' : currentTheme.headerGradient} shadow-lg border-b`}>
                        <div className="max-w-7xl mx-auto px-4 py-4 flex flex-wrap items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <h1 className={`text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-white'}`}>Support System</h1>
                            </div>
                            <div className="flex items-center gap-2 md:gap-4">
                                {/* Notification Bell */}
                                <div className="relative">
                                    <button
                                        className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-white/20 text-white hover:bg-white/30'} relative`}
                                        title="Notifications"
                                    >
                                        <Icon name="bell" size={20} />
                                        {getTicketsNearDeadline().length > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                                                {getTicketsNearDeadline().length}
                                            </span>
                                        )}
                                    </button>
                                </div>
                                
                                {/* Dark Mode Toggle */}
                                <button
                                    onClick={() => setDarkMode(!darkMode)}
                                    className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-white/20 text-white hover:bg-white/30'}`}
                                    title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                                >
                                    <Icon name={darkMode ? 'sun' : 'moon'} size={20} />
                                </button>
                                
                                {/* Welcome Button */}
                                <button
                                    onClick={() => setShowWelcome(true)}
                                    className={`hidden md:flex items-center gap-2 px-3 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-white/20 hover:bg-white/30'} text-white`}
                                >
                                    <Icon name="home" size={18} />
                                    <span className="text-sm">Welcome</span>
                                </button>
                                
                                {/* User Info */}
                                <div className="flex items-center gap-2">
                                    <Icon name="user" size={18} className={darkMode ? 'text-white' : 'text-white'} />
                                    <span className={`font-medium hidden md:inline ${darkMode ? 'text-white' : 'text-white'}`}>{currentUser.username}</span>
                                    <span className={`text-xs ${darkMode ? 'bg-gray-700' : 'bg-white/30'} text-white px-2 py-1 rounded`}>{currentUser.role}</span>
                                </div>
                                
                                {/* Logout */}
                                <button onClick={handleLogout} className={`flex items-center gap-2 px-3 md:px-4 py-2 ${darkMode ? 'hover:bg-gray-700 text-white' : 'bg-white/20 hover:bg-white/30 text-white'} rounded-lg`}>
                                    <Icon name="log-out" size={18} />
                                    <span className="hidden md:inline">Logout</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto px-4 py-6 md:py-8">
                        {/* Navigation */}
                        <div className="flex flex-wrap gap-2 mb-6 overflow-x-auto pb-2">
                            <button
                                onClick={() => setCurrentView('dashboard')}
                                className={`flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                                    currentView === 'dashboard' 
                                        ? `${currentTheme.primary} text-white` 
                                        : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50'
                                }`}
                            >
                                <Icon name="layout-dashboard" />
                                Dashboard
                            </button>
                            <button
                                onClick={() => { setCurrentView('tickets'); setViewMyTickets(false); setViewArchived(false); setViewRecycleBin(false); }}
                                className={`flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                                    currentView === 'tickets' && !viewMyTickets
                                        ? `${currentTheme.primary} text-white` 
                                        : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50'
                                }`}
                            >
                                <Icon name="file-text" />
                                <span>Tickets</span>
                            </button>
                            <button
                                onClick={() => { setCurrentView('tickets'); setViewMyTickets(true); setViewArchived(false); setViewRecycleBin(false); }}
                                className={`flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                                    viewMyTickets 
                                        ? `${currentTheme.primary} text-white` 
                                        : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50'
                                }`}
                            >
                                <Icon name="user-check" />
                                <span>My Tickets</span>
                                {getMyTickets().length > 0 && (
                                    <span className="bg-white text-gray-800 text-xs px-2 py-0.5 rounded-full font-bold">
                                        {getMyTickets().length}
                                    </span>
                                )}
                            </button>
                            <button
                                onClick={() => { setCurrentView('invoices'); setViewInvoiceRecycleBin(false); }}
                                className={`flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                                    currentView === 'invoices' 
                                        ? `${currentTheme.primary} text-white` 
                                        : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50'
                                }`}
                            >
                                <Icon name="dollar-sign" />
                                <span className="hidden sm:inline">Invoices</span>
                                <span className="sm:hidden">$</span>
                                <span className="text-xs">({invoices.length})</span>
                            </button>
                            <button
                                onClick={() => setCurrentView('settings')}
                                className={`flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                                    currentView === 'settings' 
                                        ? `${currentTheme.primary} text-white` 
                                        : darkMode ? 'bg-gray-800 text-gray-300 hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50'
                                }`}
                            >
                                <Icon name="settings" />
                                <span className="hidden sm:inline">Settings</span>
                            </button>
                        </div>

                        {/* DASHBOARD VIEW */}
                        {currentView === 'dashboard' && (
                            <>
                                <div className="flex items-center justify-between mb-6 flex-wrap gap-4">
                                    <h2 className={`text-2xl md:text-3xl font-bold bg-gradient-to-r ${currentTheme.gradient} bg-clip-text text-transparent`}>
                                        Dashboard Overview
                                    </h2>
                                    <select
                                        value={selectedYear}
                                        onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                                        className={`px-4 py-2 rounded-lg border ${darkMode ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-300'}`}
                                    >
                                        {[...Array(5)].map((_, i) => {
                                            const year = new Date().getFullYear() - i;
                                            return <option key={year} value={year}>{year} Performance</option>;
                                        })}
                                    </select>
                                </div>
                                
                                {/* Enhanced Stats Cards with Ticket Summary */}
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                                    {/* Overdue Tickets */}
                                    <div className={`${darkMode ? 'bg-gradient-to-br from-red-900/50 to-red-800/30 border border-red-700' : 'bg-gradient-to-br from-red-50 to-red-100 border border-red-200'} rounded-xl shadow-lg p-6`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <Icon name="alert-circle" className="text-red-600" size={24} />
                                            <span className={`text-3xl font-bold ${darkMode ? 'text-red-400' : 'text-red-600'}`}>
                                                {getOverdueTickets().length}
                                            </span>
                                        </div>
                                        <p className={`text-sm font-medium ${darkMode ? 'text-red-300' : 'text-red-700'}`}>Overdue</p>
                                    </div>
                                    
                                    {/* Due Today */}
                                    <div className={`${darkMode ? 'bg-gradient-to-br from-yellow-900/50 to-yellow-800/30 border border-yellow-700' : 'bg-gradient-to-br from-yellow-50 to-yellow-100 border border-yellow-200'} rounded-xl shadow-lg p-6`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <Icon name="clock" className="text-yellow-600" size={24} />
                                            <span className={`text-3xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                                                {getTicketsDueToday().length}
                                            </span>
                                        </div>
                                        <p className={`text-sm font-medium ${darkMode ? 'text-yellow-300' : 'text-yellow-700'}`}>Due Today</p>
                                    </div>
                                    
                                    {/* Open Tickets */}
                                    <div className={`${darkMode ? 'bg-gradient-to-br from-green-900/50 to-green-800/30 border border-green-700' : 'bg-gradient-to-br from-green-50 to-green-100 border border-green-200'} rounded-xl shadow-lg p-6`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <Icon name="check-circle" className="text-green-600" size={24} />
                                            <span className={`text-3xl font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                                {getOpenTickets().length}
                                            </span>
                                        </div>
                                        <p className={`text-sm font-medium ${darkMode ? 'text-green-300' : 'text-green-700'}`}>Open</p>
                                    </div>
                                
                                    {/* Active Tickets Card */}
                                    <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : currentTheme.cardGradient + ' border border-gray-200'} rounded-xl shadow-lg p-6`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <h3 className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Active Tickets</h3>
                                            <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                                <Icon name="file-text" className="text-blue-600" size={20} />
                                            </div>
                                        </div>
                                        <p className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{tickets.length}</p>
                                        <p className={`text-sm mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                            {tickets.filter(t => t.urgency === 'high').length} high priority
                                        </p>
                                    </div>

                                    {/* Archived Tickets Card */}
                                    <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <h3 className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Completed</h3>
                                            <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                                <Icon name="check-circle" className="text-green-600" size={20} />
                                            </div>
                                        </div>
                                        <p className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{archivedTickets.length}</p>
                                        <p className={`text-sm mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                            Total completed
                                        </p>
                                    </div>

                                    {/* Invoices Card */}
                                    <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <h3 className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Invoices</h3>
                                            <div className="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                                                <Icon name="dollar-sign" className="text-yellow-600" size={20} />
                                            </div>
                                        </div>
                                        <p className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{invoices.length}</p>
                                        <p className={`text-sm mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                            {invoices.filter(inv => !inv.paid).length} unpaid
                                        </p>
                                    </div>

                                    {/* Revenue Card */}
                                    <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <h3 className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Total Revenue</h3>
                                            <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                                <Icon name="trending-up" className="text-green-600" size={20} />
                                            </div>
                                        </div>
                                        <p className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                            {formatCurrency(invoices.reduce((sum, inv) => sum + inv.totalCost, 0))}
                                        </p>
                                        <p className={`text-sm mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                            {formatCurrency(invoices.filter(inv => inv.paid).reduce((sum, inv) => sum + inv.totalCost, 0))} paid
                                        </p>
                                    </div>
                                </div>

                                {/* Urgency Breakdown */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    {/* Ticket Urgency */}
                                    <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <h3 className={`text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Ticket Urgency</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <div className="flex justify-between mb-2">
                                                    <span className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        <div className="w-3 h-3 rounded-full bg-red-500"></div>
                                                        High
                                                    </span>
                                                    <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                        {tickets.filter(t => t.urgency === 'high').length}
                                                    </span>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-2">
                                                    <div 
                                                        className="bg-red-500 h-2 rounded-full" 
                                                        style={{width: `${tickets.length ? (tickets.filter(t => t.urgency === 'high').length / tickets.length * 100) : 0}%`}}
                                                    ></div>
                                                </div>
                                            </div>
                                            <div>
                                                <div className="flex justify-between mb-2">
                                                    <span className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        <div className="w-3 h-3 rounded-full bg-amber-500"></div>
                                                        Medium
                                                    </span>
                                                    <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                        {tickets.filter(t => t.urgency === 'medium').length}
                                                    </span>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-2">
                                                    <div 
                                                        className="bg-amber-500 h-2 rounded-full" 
                                                        style={{width: `${tickets.length ? (tickets.filter(t => t.urgency === 'medium').length / tickets.length * 100) : 0}%`}}
                                                    ></div>
                                                </div>
                                            </div>
                                            <div>
                                                <div className="flex justify-between mb-2">
                                                    <span className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        <div className="w-3 h-3 rounded-full bg-green-500"></div>
                                                        Low
                                                    </span>
                                                    <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                        {tickets.filter(t => t.urgency === 'low').length}
                                                    </span>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-2">
                                                    <div 
                                                        className="bg-green-500 h-2 rounded-full" 
                                                        style={{width: `${tickets.length ? (tickets.filter(t => t.urgency === 'low').length / tickets.length * 100) : 0}%`}}
                                                    ></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Staff Workload */}
                                    <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <h3 className={`text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Staff Workload</h3>
                                        <div className="space-y-3">
                                            {staffMembers.map(staff => {
                                                const staffTickets = tickets.filter(t => t.assignedTo === staff).length;
                                                const maxTickets = Math.max(...staffMembers.map(s => tickets.filter(t => t.assignedTo === s).length), 1);
                                                return (
                                                    <div key={staff} className={`flex items-center gap-3 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                                        <div className={`flex-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{staff}</div>
                                                        <div className="flex items-center gap-2 flex-1">
                                                            <div className="flex-1 bg-gray-200 rounded-full h-2">
                                                                <div 
                                                                    className={`${currentTheme.primary} h-2 rounded-full`}
                                                                    style={{width: `${(staffTickets / maxTickets * 100)}%`}}
                                                                ></div>
                                                            </div>
                                                            <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} w-8 text-right`}>
                                                                {staffTickets}
                                                            </span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>

                                {/* Pie Chart and Monthly Recap */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    {/* Urgency Pie Chart */}
                                    <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <h3 className={`text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Urgency Distribution</h3>
                                        <div className="flex items-center justify-center">
                                            <svg width="200" height="200" viewBox="0 0 200 200">
                                                {(() => {
                                                    const highCount = tickets.filter(t => t.urgency === 'high').length;
                                                    const mediumCount = tickets.filter(t => t.urgency === 'medium').length;
                                                    const lowCount = tickets.filter(t => t.urgency === 'low').length;
                                                    const total = highCount + mediumCount + lowCount || 1;
                                                    
                                                    const highPercent = (highCount / total) * 100;
                                                    const mediumPercent = (mediumCount / total) * 100;
                                                    const lowPercent = (lowCount / total) * 100;
                                                    
                                                    let currentAngle = 0;
                                                    const centerX = 100;
                                                    const centerY = 100;
                                                    const radius = 80;
                                                    
                                                    const createSlice = (percent, color) => {
                                                        const angle = (percent / 100) * 360;
                                                        const startAngle = currentAngle;
                                                        const endAngle = currentAngle + angle;
                                                        currentAngle = endAngle;
                                                        
                                                        const startRad = (startAngle - 90) * Math.PI / 180;
                                                        const endRad = (endAngle - 90) * Math.PI / 180;
                                                        
                                                        const x1 = centerX + radius * Math.cos(startRad);
                                                        const y1 = centerY + radius * Math.sin(startRad);
                                                        const x2 = centerX + radius * Math.cos(endRad);
                                                        const y2 = centerY + radius * Math.sin(endRad);
                                                        
                                                        const largeArc = angle > 180 ? 1 : 0;
                                                        
                                                        return `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                                    };
                                                    
                                                    return (
                                                        <>
                                                            {highPercent > 0 && <path d={createSlice(highPercent, '#ef4444')} fill="#ef4444" />}
                                                            {mediumPercent > 0 && <path d={createSlice(mediumPercent, '#f59e0b')} fill="#f59e0b" />}
                                                            {lowPercent > 0 && <path d={createSlice(lowPercent, '#10b981')} fill="#10b981" />}
                                                        </>
                                                    );
                                                })()}
                                            </svg>
                                        </div>
                                        <div className="mt-4 space-y-2">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-4 h-4 rounded bg-red-500"></div>
                                                    <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>High</span>
                                                </div>
                                                <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                    {tickets.filter(t => t.urgency === 'high').length} ({tickets.length ? Math.round((tickets.filter(t => t.urgency === 'high').length / tickets.length) * 100) : 0}%)
                                                </span>
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-4 h-4 rounded bg-amber-500"></div>
                                                    <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>Medium</span>
                                                </div>
                                                <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                    {tickets.filter(t => t.urgency === 'medium').length} ({tickets.length ? Math.round((tickets.filter(t => t.urgency === 'medium').length / tickets.length) * 100) : 0}%)
                                                </span>
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-4 h-4 rounded bg-green-500"></div>
                                                    <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>Low</span>
                                                </div>
                                                <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                    {tickets.filter(t => t.urgency === 'low').length} ({tickets.length ? Math.round((tickets.filter(t => t.urgency === 'low').length / tickets.length) * 100) : 0}%)
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Monthly Recap */}
                                    <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <h3 className={`text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>This Month's Performance</h3>
                                        <div className="space-y-4">
                                            {(() => {
                                                const now = new Date();
                                                const currentMonth = now.getMonth();
                                                const currentYear = now.getFullYear();
                                                
                                                const thisMonthArchived = archivedTickets.filter(t => {
                                                    const completedDate = new Date(t.completedAt || t.archivedAt);
                                                    return completedDate.getMonth() === currentMonth && completedDate.getFullYear() === currentYear;
                                                }).length;
                                                
                                                const thisMonthInvoices = invoices.filter(inv => {
                                                    const invDate = new Date(inv.jobDate);
                                                    return invDate.getMonth() === currentMonth && invDate.getFullYear() === currentYear;
                                                });
                                                
                                                const thisMonthRevenue = thisMonthInvoices.reduce((sum, inv) => sum + inv.totalCost, 0);
                                                const thisMonthPaid = thisMonthInvoices.filter(inv => inv.paid).reduce((sum, inv) => sum + inv.totalCost, 0);
                                                
                                                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                
                                                return (
                                                    <>
                                                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                                                            <div className="flex items-center justify-between">
                                                                <div>
                                                                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Month</p>
                                                                    <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                                        {monthNames[currentMonth]} {currentYear}
                                                                    </p>
                                                                </div>
                                                                <Icon name="calendar" size={32} className={darkMode ? 'text-blue-400' : 'text-blue-600'} />
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-green-50'}`}>
                                                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Completed</p>
                                                                <p className={`text-2xl font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>{thisMonthArchived}</p>
                                                            </div>
                                                            <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-yellow-50'}`}>
                                                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Invoices</p>
                                                                <p className={`text-2xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>{thisMonthInvoices.length}</p>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-purple-50'}`}>
                                                            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Revenue</p>
                                                            <p className={`text-2xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>
                                                                {formatCurrency(thisMonthRevenue)}
                                                            </p>
                                                            <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-600'} mt-1`}>
                                                                {formatCurrency(thisMonthPaid)} collected
                                                            </p>
                                                        </div>
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                </div>

                                {/* Recent Activity */}
                                <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-6`}>
                                    <h3 className={`text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Recent Tickets</h3>
                                    <div className="space-y-3">
                                        {tickets.slice(0, 5).map(ticket => (
                                            <div key={ticket.id} className={`flex items-center justify-between p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                                <div className="flex items-center gap-3 flex-1">
                                                    <div className={`w-3 h-3 rounded-full ${getUrgencyColor(ticket.urgency)}`}></div>
                                                    <div className="flex-1">
                                                        <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{ticket.client}</p>
                                                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                            {ticket.description.length > 50 ? ticket.description.substring(0, 50) + '...' : ticket.description}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{ticket.assignedTo}</p>
                                                    <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                                                        {ticket.deadline ? new Date(ticket.deadline).toLocaleDateString() : 'No deadline'}
                                                    </p>
                                                </div>
                                            </div>
                                        ))}
                                        {tickets.length === 0 && (
                                            <p className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                                No active tickets. Create one to get started!
                                            </p>
                                        )}
                                    </div>
                                </div>
                            </>
                        )}

                        {/* TICKETS VIEW */}
                        {currentView === 'tickets' && (
                            <>
                                <div className="flex items-center justify-between mb-6">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => { setViewArchived(false); setViewRecycleBin(false); }}
                                            className={`px-4 py-2 rounded-lg font-medium ${
                                                !viewArchived && !viewRecycleBin
                                                    ? `${currentTheme.primary} text-white` 
                                                    : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-white text-gray-700 hover:bg-gray-100'
                                            }`}
                                        >
                                            Active ({tickets.length})
                                        </button>
                                        <button
                                            onClick={() => { setViewArchived(true); setViewRecycleBin(false); }}
                                            className={`px-4 py-2 rounded-lg font-medium ${
                                                viewArchived && !viewRecycleBin
                                                    ? `${currentTheme.primary} text-white` 
                                                    : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-white text-gray-700 hover:bg-gray-100'
                                            }`}
                                        >
                                            Archived ({archivedTickets.length})
                                        </button>
                                        <button
                                            onClick={() => { setViewRecycleBin(true); setViewArchived(false); }}
                                            className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium ${
                                                viewRecycleBin
                                                    ? `${currentTheme.primary} text-white` 
                                                    : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-white text-gray-700 hover:bg-gray-100'
                                            }`}
                                        >
                                            <Icon name="trash-2" size={16} />
                                            Recycle Bin ({recycleBin.length})
                                        </button>
                                    </div>
                                    
                                    {!viewArchived && !viewRecycleBin && (
                                        <button
                                            onClick={() => setShowNewTicket(true)}
                                            className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Icon name="plus" />
                                            New Ticket
                                        </button>
                                    )}
                                    
                                    {viewRecycleBin && recycleBin.length > 0 && (
                                        <button
                                            onClick={emptyRecycleBin}
                                            className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                        >
                                            <Icon name="trash-2" size={16} />
                                            Empty Bin
                                        </button>
                                    )}
                                </div>

                                <div className="space-y-4">
                                    {displayTickets.map(ticket => {
                                        const dateTime = formatDateTime(ticket.createdAt);
                                        const isEditing = editingTicket === ticket.id;
                                        
                                        return (
                                            <div key={ticket.id} className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow`}>
                                                <div className="p-6">
                                                    {isEditing ? (
                                                        <div className="space-y-4">
                                                            <input
                                                                type="text"
                                                                value={editForm.client}
                                                                onChange={(e) => setEditForm({ ...editForm, client: e.target.value })}
                                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                                placeholder="Client"
                                                            />
                                                            <textarea
                                                                value={editForm.description}
                                                                onChange={(e) => setEditForm({ ...editForm, description: e.target.value })}
                                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                                rows="3"
                                                                placeholder="Description"
                                                            />
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div>
                                                                    <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                                        Priority
                                                                    </label>
                                                                    <select
                                                                        value={editForm.priority || 'amber'}
                                                                        onChange={(e) => setEditForm({ ...editForm, priority: e.target.value })}
                                                                        className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                                    >
                                                                        <option value="red">ðŸ”´ Red</option>
                                                                        <option value="amber">ðŸŸ  Amber</option>
                                                                        <option value="green">ðŸŸ¢ Green</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                                        Urgency
                                                                    </label>
                                                                    <select
                                                                        value={editForm.urgency || 'medium'}
                                                                        onChange={(e) => setEditForm({ ...editForm, urgency: e.target.value })}
                                                                        className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                                    >
                                                                        <option value="high">ðŸ”´ High</option>
                                                                        <option value="medium">ðŸŸ¡ Medium</option>
                                                                        <option value="low">ðŸŸ¢ Low</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                                    Deadline
                                                                </label>
                                                                <input
                                                                    type="date"
                                                                    value={editForm.deadline || ''}
                                                                    onChange={(e) => setEditForm({ ...editForm, deadline: e.target.value })}
                                                                    className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                                    Assigned To
                                                                </label>
                                                                <select
                                                                    value={editForm.assignedTo}
                                                                    onChange={(e) => setEditForm({ ...editForm, assignedTo: e.target.value })}
                                                                    className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                                >
                                                                    {staffMembers.map(staff => (
                                                                        <option key={staff} value={staff}>{staff}</option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={() => saveEdit(ticket.id)}
                                                                    className={`px-4 py-2 ${currentTheme.primary} text-white rounded-lg`}
                                                                >
                                                                    Save
                                                                </button>
                                                                <button
                                                                    onClick={() => setEditingTicket(null)}
                                                                    className={`px-4 py-2 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200'} rounded-lg`}
                                                                >
                                                                    Cancel
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <div className="flex items-start gap-4">
                                                                {/* Traffic Light Urgency Indicator */}
                                                                <div className="flex flex-col items-center gap-2">
                                                                    <div className={`w-10 h-10 rounded-full ${getUrgencyColor(ticket.urgency)} flex items-center justify-center shadow-lg`}>
                                                                        {ticket.completed && (
                                                                            <Icon name="check" size={24} className="text-white" />
                                                                        )}
                                                                    </div>
                                                                    <span className={`text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                        {getUrgencyLabel(ticket.urgency)}
                                                                    </span>
                                                                </div>
                                                                
                                                                <div className="flex-1">
                                                                    <div className="flex items-center gap-2 mb-1">
                                                                        <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{ticket.client}</h3>
                                                                        {ticket.completed && (
                                                                            <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium flex items-center gap-1">
                                                                                <Icon name="check-circle" size={14} />
                                                                                Completed
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'} text-sm mb-3`}>{ticket.description}</p>
                                                                    <div className="grid grid-cols-5 gap-4 text-sm">
                                                                        <div>
                                                                            <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>Date Sent:</span>
                                                                            <span className={`font-medium ml-2 ${darkMode ? 'text-gray-200' : ''}`}>
                                                                                {ticket.dateSent ? new Date(ticket.dateSent).toLocaleDateString() : 'N/A'}
                                                                            </span>
                                                                        </div>
                                                                        <div>
                                                                            <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>Deadline:</span>
                                                                            <span className={`font-medium ml-2 ${darkMode ? 'text-gray-200' : ''}`}>
                                                                                {ticket.deadline ? new Date(ticket.deadline).toLocaleDateString() : 'N/A'}
                                                                            </span>
                                                                        </div>
                                                                        <div>
                                                                            <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>Assigned:</span>
                                                                            <span className={`font-medium ml-2 ${darkMode ? 'text-gray-200' : ''}`}>{ticket.assignedTo}</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>By:</span>
                                                                            <span className={`font-medium ml-2 ${darkMode ? 'text-gray-200' : ''}`}>{ticket.createdBy}</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>Urgency:</span>
                                                                            <span className={`font-medium ml-2 ${darkMode ? 'text-gray-200' : ''}`}>{getUrgencyLabel(ticket.urgency)}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className={`flex gap-2 mt-4 pt-4 border-t ${darkMode ? 'border-gray-700' : ''}`}>
                                                                {viewRecycleBin ? (
                                                                    <>
                                                                        <button
                                                                            onClick={() => restoreFromBin(ticket.id)}
                                                                            className="flex items-center gap-1 px-3 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700"
                                                                        >
                                                                            <Icon name="rotate-ccw" size={14} />
                                                                            Restore
                                                                        </button>
                                                                        <button
                                                                            onClick={() => permanentDelete(ticket.id)}
                                                                            className="flex items-center gap-1 px-3 py-2 bg-red-600 text-white rounded-lg text-sm ml-auto hover:bg-red-700"
                                                                        >
                                                                            <Icon name="x-circle" size={14} />
                                                                            Delete Permanently
                                                                        </button>
                                                                    </>
                                                                ) : !viewArchived ? (
                                                                    <>
                                                                        <button
                                                                            onClick={() => startEdit(ticket)}
                                                                            className={`flex items-center gap-1 px-3 py-2 ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg text-sm`}
                                                                        >
                                                                            <Icon name="edit" size={14} />
                                                                            Edit
                                                                        </button>
                                                                        <button
                                                                            onClick={() => markComplete(ticket.id)}
                                                                            className="flex items-center gap-1 px-3 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700"
                                                                        >
                                                                            <Icon name="check-circle" size={14} />
                                                                            Complete & Archive
                                                                        </button>
                                                                        <button
                                                                            onClick={() => deleteTicket(ticket.id)}
                                                                            className="flex items-center gap-1 px-3 py-2 bg-red-600 text-white rounded-lg text-sm ml-auto hover:bg-red-700"
                                                                        >
                                                                            <Icon name="trash-2" size={14} />
                                                                            Delete
                                                                        </button>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <button
                                                                            onClick={() => unarchiveTicket(ticket.id)}
                                                                            className="flex items-center gap-1 px-3 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700"
                                                                        >
                                                                            <Icon name="archive" size={14} />
                                                                            Unarchive
                                                                        </button>
                                                                        <button
                                                                            onClick={() => deleteArchivedTicket(ticket.id)}
                                                                            className="flex items-center gap-1 px-3 py-2 bg-red-600 text-white rounded-lg text-sm ml-auto hover:bg-red-700"
                                                                        >
                                                                            <Icon name="trash-2" size={14} />
                                                                            Delete
                                                                        </button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        )}

                        {/* INVOICES VIEW */}
                        {currentView === 'invoices' && (
                            <>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : ''}`}>Invoices</h2>
                                    <button
                                        onClick={() => setShowNewInvoice(true)}
                                        className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        <Icon name="plus" />
                                        New Invoice
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    {invoices.map(invoice => {
                                        const isEditingInvoice = editingInvoice === invoice.id;
                                        
                                        return (
                                            <div key={invoice.id} className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-6`}>
                                                {isEditingInvoice ? (
                                                    <div className="space-y-4">
                                                        <input
                                                            type="text"
                                                            placeholder="Client Name"
                                                            value={invoiceEditForm.client}
                                                            onChange={(e) => setInvoiceEditForm({ ...invoiceEditForm, client: e.target.value })}
                                                            className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                        />
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <input
                                                                type="email"
                                                                placeholder="Client Email (optional)"
                                                                value={invoiceEditForm.clientEmail || ''}
                                                                onChange={(e) => setInvoiceEditForm({ ...invoiceEditForm, clientEmail: e.target.value })}
                                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                            />
                                                            <input
                                                                type="tel"
                                                                placeholder="Client Phone (optional)"
                                                                value={invoiceEditForm.clientPhone || ''}
                                                                onChange={(e) => setInvoiceEditForm({ ...invoiceEditForm, clientPhone: e.target.value })}
                                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                            />
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <input
                                                                type="number"
                                                                placeholder="Hours"
                                                                value={invoiceEditForm.hours}
                                                                onChange={(e) => setInvoiceEditForm({ ...invoiceEditForm, hours: e.target.value })}
                                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                            />
                                                            <input
                                                                type="number"
                                                                placeholder="Cost/Hour"
                                                                value={invoiceEditForm.cost}
                                                                onChange={(e) => setInvoiceEditForm({ ...invoiceEditForm, cost: e.target.value })}
                                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                            />
                                                        </div>
                                                        <textarea
                                                            placeholder="Job Description"
                                                            value={invoiceEditForm.jobDescription || ''}
                                                            onChange={(e) => setInvoiceEditForm({ ...invoiceEditForm, jobDescription: e.target.value })}
                                                            className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                            rows="3"
                                                        />
                                                        <input
                                                            type="date"
                                                            value={invoiceEditForm.jobDate || ''}
                                                            onChange={(e) => setInvoiceEditForm({ ...invoiceEditForm, jobDate: e.target.value })}
                                                            className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                        />
                                                        <select
                                                            value={invoiceEditForm.assignedTo || ''}
                                                            onChange={(e) => setInvoiceEditForm({ ...invoiceEditForm, assignedTo: e.target.value })}
                                                            className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                                        >
                                                            <option value="">Assign to...</option>
                                                            {staffMembers.map(staff => (
                                                                <option key={staff} value={staff}>{staff}</option>
                                                            ))}
                                                        </select>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => saveInvoiceEdit(invoice.id)}
                                                                className={`px-4 py-2 ${currentTheme.primary} text-white rounded-lg`}
                                                            >
                                                                Save
                                                            </button>
                                                            <button
                                                                onClick={() => setEditingInvoice(null)}
                                                                className={`px-4 py-2 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200'} rounded-lg`}
                                                            >
                                                                Cancel
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div className="flex-1">
                                                                <div className="flex items-center gap-3 mb-2">
                                                                    <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{invoice.client}</h3>
                                                                    {invoice.paid && (
                                                                        <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                                                                            âœ“ Paid
                                                                        </span>
                                                                    )}
                                                                </div>
                                                                {(invoice.clientEmail || invoice.clientPhone) && (
                                                                    <div className={`flex gap-4 mb-2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                        {invoice.clientEmail && <span>ðŸ“§ {invoice.clientEmail}</span>}
                                                                        {invoice.clientPhone && <span>ðŸ“ž {invoice.clientPhone}</span>}
                                                                    </div>
                                                                )}
                                                                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'} text-sm`}>{invoice.jobDescription}</p>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className={`text-2xl font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                                                    {formatCurrency(invoice.totalCost)}
                                                                </div>
                                                                <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                                                    {invoice.hours}h @ {formatCurrency(invoice.cost)}/h
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="mt-4 grid grid-cols-4 gap-4 text-sm">
                                                            <div>
                                                                <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>Date:</span>
                                                                <span className={`font-medium ml-2 ${darkMode ? 'text-gray-200' : ''}`}>{invoice.jobDate}</span>
                                                            </div>
                                                            <div>
                                                                <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>Assigned:</span>
                                                                <span className={`font-medium ml-2 ${darkMode ? 'text-gray-200' : ''}`}>{invoice.assignedTo}</span>
                                                            </div>
                                                            <div>
                                                                <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>Charge:</span>
                                                                <span className={`font-medium ml-2 ${darkMode ? 'text-gray-200' : ''}`}>
                                                                    {invoice.chargeTiming === 'now' ? 'Now' : 'End of Month'}
                                                                </span>
                                                            </div>
                                                            <div>
                                                                <span className={darkMode ? 'text-gray-400' : 'text-gray-500'}>QuickBooks:</span>
                                                                <span className={`font-medium ml-2 ${darkMode ? 'text-gray-200' : ''}`}>{invoice.quickbooks ? 'Yes' : 'No'}</span>
                                                            </div>
                                                        </div>
                                                        <div className={`flex gap-2 mt-4 pt-4 border-t ${darkMode ? 'border-gray-700' : ''}`}>
                                                            <button
                                                                onClick={() => startEditInvoice(invoice)}
                                                                className={`flex items-center gap-1 px-3 py-2 rounded-lg text-sm ${darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-600 hover:bg-blue-700'} text-white`}
                                                            >
                                                                <Icon name="edit" size={14} />
                                                                Edit
                                                            </button>
                                                            <button
                                                                onClick={() => toggleInvoicePaid(invoice.id)}
                                                                className={`flex items-center gap-1 px-3 py-2 rounded-lg text-sm ${
                                                                    invoice.paid 
                                                                        ? darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                                        : 'bg-green-600 text-white hover:bg-green-700'
                                                                }`}
                                                            >
                                                                <Icon name="check-circle" size={14} />
                                                                {invoice.paid ? 'Mark Unpaid' : 'Mark Paid'}
                                                            </button>
                                                            <button
                                                                onClick={() => deleteInvoice(invoice.id)}
                                                                className="flex items-center gap-1 px-3 py-2 bg-red-600 text-white rounded-lg text-sm ml-auto hover:bg-red-700"
                                                            >
                                                                <Icon name="trash-2" size={14} />
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        )}

                        {/* SETTINGS VIEW */}
                        {currentView === 'settings' && (
                            <>
                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow mb-6`}>
                                    <div className="flex border-b">
                                        <button
                                            onClick={() => setSettingsTab('account')}
                                            className={`px-6 py-4 font-medium ${
                                                settingsTab === 'account' 
                                                    ? `border-b-2 ${currentTheme.primaryBorder} ${currentTheme.primaryText}` 
                                                    : darkMode ? 'text-gray-400' : 'text-gray-600'
                                            }`}
                                        >
                                            Account
                                        </button>
                                        <button
                                            onClick={() => setSettingsTab('theme')}
                                            className={`px-6 py-4 font-medium ${
                                                settingsTab === 'theme' 
                                                    ? `border-b-2 ${currentTheme.primaryBorder} ${currentTheme.primaryText}` 
                                                    : darkMode ? 'text-gray-400' : 'text-gray-600'
                                            }`}
                                        >
                                            Theme
                                        </button>
                                        {currentUser.role === 'admin' && (
                                            <>
                                                <button
                                                    onClick={() => setSettingsTab('staff')}
                                                    className={`px-6 py-4 font-medium ${
                                                        settingsTab === 'staff' 
                                                            ? `border-b-2 ${currentTheme.primaryBorder} ${currentTheme.primaryText}` 
                                                            : darkMode ? 'text-gray-400' : 'text-gray-600'
                                                    }`}
                                                >
                                                    Staff
                                                </button>
                                                <button
                                                    onClick={() => setSettingsTab('workload')}
                                                    className={`px-6 py-4 font-medium ${
                                                        settingsTab === 'workload' 
                                                            ? `border-b-2 ${currentTheme.primaryBorder} ${currentTheme.primaryText}` 
                                                            : darkMode ? 'text-gray-400' : 'text-gray-600'
                                                    }`}
                                                >
                                                    Workload Chart
                                                </button>
                                            </>
                                        )}
                                    </div>
                                </div>

                                {settingsTab === 'account' && (
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <h2 className={`text-xl font-bold mb-6 ${darkMode ? 'text-white' : ''}`}>Account Settings</h2>
                                        
                                        {/* User Info */}
                                        <div className={`mb-6 p-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg`}>
                                            <h3 className={`font-medium mb-3 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Account Information</h3>
                                            <div className="space-y-3">
                                                <div className="flex justify-between items-center">
                                                    <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Username:</span>
                                                    <span className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{currentUser.username}</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Email:</span>
                                                    <div className="flex items-center gap-2">
                                                        {isEditingEmail ? (
                                                            <>
                                                                <input
                                                                    type="email"
                                                                    value={emailEdit}
                                                                    onChange={(e) => setEmailEdit(e.target.value)}
                                                                    className={`px-3 py-1 border rounded ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`}
                                                                    placeholder="your@email.com"
                                                                />
                                                                <button
                                                                    onClick={saveEmail}
                                                                    className={`px-3 py-1 ${currentTheme.primary} text-white rounded text-sm`}
                                                                >
                                                                    Save
                                                                </button>
                                                                <button
                                                                    onClick={() => setIsEditingEmail(false)}
                                                                    className={`px-3 py-1 ${darkMode ? 'bg-gray-600 text-white' : 'bg-gray-200'} rounded text-sm`}
                                                                >
                                                                    Cancel
                                                                </button>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{currentUser.email}</span>
                                                                <button
                                                                    onClick={() => {
                                                                        setEmailEdit(currentUser.email);
                                                                        setIsEditingEmail(true);
                                                                    }}
                                                                    className={`text-sm ${currentTheme.primaryText} hover:underline`}
                                                                >
                                                                    Edit
                                                                </button>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Role:</span>
                                                    <span className={`font-medium capitalize ${darkMode ? 'text-white' : 'text-gray-900'}`}>{currentUser.role}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Admin User Management */}
                                        {currentUser.role === 'admin' && (
                                            <div className={`mb-6 p-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg`}>
                                                <h3 className={`font-medium mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Manage Users (Admin Only)</h3>
                                                <div className="space-y-3">
                                                    {users.map(user => (
                                                        <div key={user.id} className={`p-4 ${darkMode ? 'bg-gray-600' : 'bg-white'} rounded-lg border ${darkMode ? 'border-gray-500' : 'border-gray-200'}`}>
                                                            <div className="flex justify-between items-center mb-3">
                                                                <span className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{user.username}</span>
                                                                <span className={`text-xs px-2 py-1 rounded ${user.role === 'admin' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                                                                    {user.role}
                                                                </span>
                                                            </div>
                                                            
                                                            <div className="space-y-3">
                                                                {/* Role Change */}
                                                                <div>
                                                                    <label className={`block text-xs mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Change Role</label>
                                                                    <select
                                                                        value={user.role}
                                                                        onChange={(e) => adminChangeUserRole(user.id, e.target.value)}
                                                                        className={`w-full px-3 py-2 text-sm border rounded ${darkMode ? 'bg-gray-700 border-gray-500 text-white' : 'border-gray-300'}`}
                                                                        disabled={user.id === currentUser.id}
                                                                    >
                                                                        <option value="user">User</option>
                                                                        <option value="admin">Admin</option>
                                                                    </select>
                                                                    {user.id === currentUser.id && (
                                                                        <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>You cannot change your own role</p>
                                                                    )}
                                                                </div>
                                                                
                                                                {/* Password Reset */}
                                                                <div>
                                                                    <label className={`block text-xs mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Reset Password (min 6 characters)</label>
                                                                    <div className="flex gap-2">
                                                                        <input
                                                                            type="password"
                                                                            value={resetPasswordInputs[user.id] || ''}
                                                                            onChange={(e) => setResetPasswordInputs(prev => ({ ...prev, [user.id]: e.target.value }))}
                                                                            placeholder="Enter new password"
                                                                            className={`flex-1 px-3 py-2 text-sm border rounded ${darkMode ? 'bg-gray-700 border-gray-500 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-400'}`}
                                                                        />
                                                                        <button
                                                                            onClick={() => {
                                                                                if (resetPasswordInputs[user.id]) {
                                                                                    adminResetUserPassword(user.id, resetPasswordInputs[user.id]);
                                                                                } else {
                                                                                    alert('Please enter a new password');
                                                                                }
                                                                            }}
                                                                            className={`px-4 py-2 text-sm ${currentTheme.primary} text-white rounded ${currentTheme.primaryHover}`}
                                                                        >
                                                                            Reset
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* Change Password */}
                                        <div className={`p-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg`}>
                                            <h3 className={`font-medium mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>Change Your Password</h3>
                                            <div className="space-y-4 max-w-md">
                                                <div>
                                                    <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        Current Password
                                                    </label>
                                                    <input
                                                        type="password"
                                                        value={passwordChange.current}
                                                        onChange={(e) => setPasswordChange({ ...passwordChange, current: e.target.value })}
                                                        className={`w-full px-4 py-2 border rounded-lg ${
                                                            darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'
                                                        }`}
                                                        placeholder="Enter current password"
                                                    />
                                                </div>
                                                <div>
                                                    <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        New Password
                                                    </label>
                                                    <input
                                                        type="password"
                                                        value={passwordChange.new}
                                                        onChange={(e) => setPasswordChange({ ...passwordChange, new: e.target.value })}
                                                        className={`w-full px-4 py-2 border rounded-lg ${
                                                            darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'
                                                        }`}
                                                        placeholder="Enter new password (min 6 characters)"
                                                    />
                                                </div>
                                                <div>
                                                    <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        Confirm New Password
                                                    </label>
                                                    <input
                                                        type="password"
                                                        value={passwordChange.confirm}
                                                        onChange={(e) => setPasswordChange({ ...passwordChange, confirm: e.target.value })}
                                                        className={`w-full px-4 py-2 border rounded-lg ${
                                                            darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'
                                                        }`}
                                                        placeholder="Confirm new password"
                                                    />
                                                </div>
                                                <button
                                                    onClick={changePassword}
                                                    className={`${currentTheme.primary} ${currentTheme.primaryHover} text-white px-6 py-2 rounded-lg font-medium`}
                                                >
                                                    Change Password
                                                </button>
                                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                    Password must be at least 6 characters long
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {settingsTab === 'theme' && (
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <h2 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : ''}`}>Theme Settings</h2>
                                        
                                        {/* Dark Mode Toggle */}
                                        <div className={`mb-6 p-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg`}>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <h3 className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>Dark Mode</h3>
                                                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                                        Switch between light and dark themes
                                                    </p>
                                                </div>
                                                <button
                                                    onClick={() => setDarkMode(!darkMode)}
                                                    className={`relative inline-flex h-8 w-14 items-center rounded-full transition ${
                                                        darkMode ? 'bg-blue-600' : 'bg-gray-300'
                                                    }`}
                                                >
                                                    <span
                                                        className={`inline-block h-6 w-6 transform rounded-full bg-white transition ${
                                                            darkMode ? 'translate-x-7' : 'translate-x-1'
                                                        }`}
                                                    />
                                                </button>
                                            </div>
                                        </div>

                                        <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-6`}>Choose your preferred color scheme</p>
                                        <div className="grid grid-cols-5 gap-4">
                                            {['blue', 'green', 'purple', 'orange', 'red'].map(t => (
                                                <button
                                                    key={t}
                                                    onClick={() => setTheme(t)}
                                                    className={`p-4 rounded-lg border-2 ${
                                                        theme === t ? 'border-gray-800' : darkMode ? 'border-gray-600' : 'border-gray-200'
                                                    }`}
                                                >
                                                    <div className={`w-full h-20 rounded mb-2 ${
                                                        t === 'blue' ? 'bg-blue-600' :
                                                        t === 'green' ? 'bg-green-600' :
                                                        t === 'purple' ? 'bg-purple-600' :
                                                        t === 'orange' ? 'bg-orange-600' :
                                                        'bg-red-600'
                                                    }`}></div>
                                                    <div className={`text-center capitalize ${darkMode ? 'text-white' : ''}`}>{t}</div>
                                                    {theme === t && <div className="text-center text-sm text-green-600 mt-1">âœ“ Selected</div>}
                                                </button>
                                            ))}
                                        </div>
                                        <div className={`mt-6 flex items-center gap-3 p-4 ${darkMode ? 'bg-gray-700' : currentTheme.primaryBg} rounded-lg`}>
                                            <div className="flex-1">
                                                <p className={`font-medium ${darkMode ? 'text-white' : currentTheme.primaryText.replace('text-', 'text-')}`}>
                                                    Current theme: <span className="capitalize">{theme}</span> {darkMode && '(Dark Mode)'}
                                                </p>
                                                <p className={`text-sm ${darkMode ? 'text-gray-400' : currentTheme.primaryText.replace('600', '700')}`}>
                                                    Theme is applied automatically when selected
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => alert(`Theme applied!\nColor: ${theme}\nMode: ${darkMode ? 'Dark' : 'Light'}\n\nYour preferences are active across the system.`)}
                                                className={`px-6 py-3 ${currentTheme.primary} ${currentTheme.primaryHover} text-white rounded-lg font-medium`}
                                            >
                                                Apply Theme
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {settingsTab === 'staff' && (
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : ''}`}>Staff Members</h2>
                                            <button
                                                onClick={() => setShowAddStaffModal(true)}
                                                className={`px-4 py-2 ${currentTheme.primary} text-white rounded-lg ${currentTheme.primaryHover}`}
                                            >
                                                Add Staff
                                            </button>
                                        </div>
                                        <div className="space-y-2">
                                            {staffMembers.map((staff, idx) => (
                                                <div key={idx} className={`flex justify-between items-center p-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg`}>
                                                    <span className={`font-medium ${darkMode ? 'text-white' : ''}`}>{staff}</span>
                                                    <button
                                                        onClick={() => setStaffMembers(staffMembers.filter(s => s !== staff))}
                                                        className="text-red-600 text-sm hover:text-red-700"
                                                    >
                                                        Remove
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {settingsTab === 'workload' && (
                                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
                                        <h2 className={`text-xl font-bold mb-6 ${darkMode ? 'text-white' : ''}`}>Staff Workload Distribution</h2>
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div>
                                                <canvas id="workloadChart" width="300" height="300"></canvas>
                                            </div>
                                            <div>
                                                <h3 className={`font-bold text-lg mb-4 ${darkMode ? 'text-white' : ''}`}>Ticket Assignment Summary</h3>
                                                <div className="space-y-3">
                                                    {(() => {
                                                        const workloadData = {};
                                                        tickets.forEach(ticket => {
                                                            workloadData[ticket.assignedTo] = (workloadData[ticket.assignedTo] || 0) + 1;
                                                        });
                                                        
                                                        return Object.entries(workloadData).map(([staff, count]) => (
                                                            <div key={staff} className={`flex justify-between items-center p-3 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg`}>
                                                                <span className={`font-medium ${darkMode ? 'text-white' : ''}`}>{staff}</span>
                                                                <span className={`px-3 py-1 ${darkMode ? 'bg-gray-600 text-blue-300' : 'bg-blue-100 text-blue-700'} rounded-full font-bold`}>
                                                                    {count} {count === 1 ? 'ticket' : 'tickets'}
                                                                </span>
                                                            </div>
                                                        ));
                                                    })()}
                                                    {tickets.length === 0 && (
                                                        <p className="text-gray-500 text-center py-8">No active tickets to display</p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>

                    {/* New Ticket Modal */}
                    {showNewTicket && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-6 w-full max-w-lg`}>
                                <h2 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : ''}`}>Create New Ticket</h2>
                                <div className="space-y-4">
                                    <input
                                        type="text"
                                        placeholder="Client Name"
                                        value={newTicket.client}
                                        onChange={(e) => setNewTicket({ ...newTicket, client: e.target.value })}
                                        className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300'}`}
                                    />
                                    <textarea
                                        placeholder="Description"
                                        value={newTicket.description}
                                        onChange={(e) => setNewTicket({ ...newTicket, description: e.target.value })}
                                        className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300'}`}
                                        rows="4"
                                    />
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                Urgency (Traffic Light)
                                            </label>
                                            <select
                                                value={newTicket.urgency}
                                                onChange={(e) => setNewTicket({ ...newTicket, urgency: e.target.value })}
                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                            >
                                                <option value="low">ðŸŸ¢ Low</option>
                                                <option value="medium">ðŸŸ¡ Medium</option>
                                                <option value="high">ðŸ”´ High</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                Assigned To
                                            </label>
                                            <select
                                                value={newTicket.assignedTo}
                                                onChange={(e) => setNewTicket({ ...newTicket, assignedTo: e.target.value })}
                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                            >
                                                <option value="">Select staff...</option>
                                                {staffMembers.map(staff => (
                                                    <option key={staff} value={staff}>{staff}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                Date Sent
                                            </label>
                                            <input
                                                type="date"
                                                value={newTicket.dateSent}
                                                onChange={(e) => setNewTicket({ ...newTicket, dateSent: e.target.value })}
                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                            />
                                        </div>
                                        <div>
                                            <label className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                                Deadline
                                            </label>
                                            <input
                                                type="date"
                                                value={newTicket.deadline}
                                                onChange={(e) => setNewTicket({ ...newTicket, deadline: e.target.value })}
                                                className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <button onClick={createTicket} className={`flex-1 ${currentTheme.primary} text-white py-2 rounded-lg ${currentTheme.primaryHover}`}>
                                            Create
                                        </button>
                                        <button onClick={() => setShowNewTicket(false)} className={`flex-1 ${darkMode ? 'bg-gray-700' : 'bg-gray-200'} py-2 rounded-lg`}>
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* New Invoice Modal */}
                    {showNewInvoice && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg p-6 w-full max-w-lg">
                                <h2 className="text-xl font-bold mb-4">Create New Invoice</h2>
                                <div className="space-y-4">
                                    <input
                                        type="text"
                                        placeholder="Client Name"
                                        value={newInvoice.client}
                                        onChange={(e) => setNewInvoice({ ...newInvoice, client: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                    <div className="grid grid-cols-2 gap-4">
                                        <input
                                            type="email"
                                            placeholder="Client Email (optional)"
                                            value={newInvoice.clientEmail}
                                            onChange={(e) => setNewInvoice({ ...newInvoice, clientEmail: e.target.value })}
                                            className="w-full px-4 py-2 border rounded-lg"
                                        />
                                        <input
                                            type="tel"
                                            placeholder="Client Phone (optional)"
                                            value={newInvoice.clientPhone}
                                            onChange={(e) => setNewInvoice({ ...newInvoice, clientPhone: e.target.value })}
                                            className="w-full px-4 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input
                                            type="number"
                                            placeholder="Hours"
                                            value={newInvoice.hours}
                                            onChange={(e) => setNewInvoice({ ...newInvoice, hours: e.target.value })}
                                            className="w-full px-4 py-2 border rounded-lg"
                                        />
                                        <input
                                            type="number"
                                            placeholder="Cost/Hour"
                                            value={newInvoice.cost}
                                            onChange={(e) => setNewInvoice({ ...newInvoice, cost: e.target.value })}
                                            className="w-full px-4 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <textarea
                                        placeholder="Job Description"
                                        value={newInvoice.jobDescription}
                                        onChange={(e) => setNewInvoice({ ...newInvoice, jobDescription: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                        rows="3"
                                    />
                                    <input
                                        type="date"
                                        value={newInvoice.jobDate}
                                        onChange={(e) => setNewInvoice({ ...newInvoice, jobDate: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                    <select
                                        value={newInvoice.assignedTo}
                                        onChange={(e) => setNewInvoice({ ...newInvoice, assignedTo: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    >
                                        <option value="">Assign to...</option>
                                        {staffMembers.map(staff => (
                                            <option key={staff} value={staff}>{staff}</option>
                                        ))}
                                    </select>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Charge Timing</label>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button
                                                type="button"
                                                onClick={() => setNewInvoice({ ...newInvoice, chargeTiming: 'now' })}
                                                className={`px-4 py-3 rounded-lg border-2 font-medium transition ${
                                                    newInvoice.chargeTiming === 'now'
                                                        ? 'border-blue-500 bg-blue-50 text-blue-700'
                                                        : 'border-gray-300 text-gray-700 hover:border-blue-300'
                                                }`}
                                            >
                                                Charge Now
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => setNewInvoice({ ...newInvoice, chargeTiming: 'end-of-month' })}
                                                className={`px-4 py-3 rounded-lg border-2 font-medium transition ${
                                                    newInvoice.chargeTiming === 'end-of-month'
                                                        ? 'border-blue-500 bg-blue-50 text-blue-700'
                                                        : 'border-gray-300 text-gray-700 hover:border-blue-300'
                                                }`}
                                            >
                                                End of Month
                                            </button>
                                        </div>
                                    </div>
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            checked={newInvoice.quickbooks}
                                            onChange={(e) => setNewInvoice({ ...newInvoice, quickbooks: e.target.checked })}
                                            className="w-4 h-4"
                                        />
                                        <span>Export to QuickBooks</span>
                                    </label>
                                    <div className="flex gap-2">
                                        <button onClick={createInvoice} className="flex-1 bg-blue-600 text-white py-2 rounded-lg">
                                            Create
                                        </button>
                                        <button onClick={() => setShowNewInvoice(false)} className="flex-1 bg-gray-200 py-2 rounded-lg">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add Staff Modal */}
                    {showAddStaffModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-6 w-full max-w-md`}>
                                <h2 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : ''}`}>Add Staff Member</h2>
                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                                    This will create a staff member AND a login account for them.
                                </p>
                                <div className="space-y-4">
                                    <div>
                                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-1`}>Full Name *</label>
                                        <input
                                            type="text"
                                            placeholder="e.g., John Smith"
                                            value={newStaffMember.name}
                                            onChange={(e) => setNewStaffMember({ ...newStaffMember, name: e.target.value })}
                                            className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300'}`}
                                        />
                                    </div>
                                    <div>
                                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-1`}>Username *</label>
                                        <input
                                            type="text"
                                            placeholder="e.g., jsmith"
                                            value={newStaffMember.username}
                                            onChange={(e) => setNewStaffMember({ ...newStaffMember, username: e.target.value })}
                                            className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300'}`}
                                        />
                                        <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'} mt-1`}>They'll use this to login</p>
                                    </div>
                                    <div>
                                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-1`}>Password *</label>
                                        <input
                                            type="text"
                                            placeholder="Create a password"
                                            value={newStaffMember.password}
                                            onChange={(e) => setNewStaffMember({ ...newStaffMember, password: e.target.value })}
                                            className={`w-full px-4 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300'}`}
                                        />
                                        <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'} mt-1`}>They can change this later</p>
                                    </div>
                                    <div className={`p-3 ${darkMode ? 'bg-blue-900 border-blue-700' : 'bg-blue-50 border-blue-200'} border rounded-lg`}>
                                        <p className={`text-sm ${darkMode ? 'text-blue-200' : 'text-blue-800'}`}>
                                            <strong>Note:</strong> After adding, they can login with their username and password. 
                                            Make sure to share these credentials with them securely.
                                        </p>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button onClick={addStaffMember} className={`flex-1 ${currentTheme.primary} text-white py-2 rounded-lg ${currentTheme.primaryHover}`}>
                                        Create Staff & Login
                                    </button>
                                    <button onClick={() => setShowAddStaffModal(false)} className={`flex-1 ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} py-2 rounded-lg`}>
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Logo Upload Modal */}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TicketingSystem />);
    </script>
</body>
</html>
