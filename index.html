<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genius Tech - Ticketing System (Cloud Connected)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        
        :root {
            --navy-900: #0f1419;
            --navy-800: #1a2332;
            --navy-700: #243447;
            --mint-500: #7dd3c0;
            --peach-500: #ffb4a2;
            --coral-500: #ff8b94;
            --sky-500: #6eb5ff;
        }
        
        body.light {
            --bg-primary: #fefbf7;
            --bg-secondary: #ffffff;
            --bg-sidebar: #ffffff;
            --text-primary: #1a2332;
            --text-secondary: #6b7280;
            --border-color: rgba(125, 211, 192, 0.2);
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        body.dark {
            --bg-primary: #0f1419;
            --bg-secondary: #1a2332;
            --bg-sidebar: #1a2332;
            --text-primary: #fefbf7;
            --text-secondary: #9ca3af;
            --border-color: rgba(125, 211, 192, 0.15);
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(125, 211, 192, 0.3);
            border-top-color: #7dd3c0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alert Messages */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            border-left: 4px solid #7dd3c0;
        }

        .alert-error {
            border-left: 4px solid #ff8b94;
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-message {
            font-weight: 500;
            color: #1a2332;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .sidebar {
            width: 280px;
            height: 100vh;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #7dd3c0 0%, #5a8ba0 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .logo-shape {
            position: absolute;
        }
        
        .logo-text {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 20px;
            background: linear-gradient(135deg, #7dd3c0 0%, #6eb5ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .nav {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            margin-bottom: 4px;
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(125, 211, 192, 0.1);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #7dd3c0 0%, #6eb5ff 100%);
            color: #0f1419;
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        .badge {
            margin-left: auto;
            background: var(--mint-500);
            color: #0f1419;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .nav-item.active .badge {
            background: rgba(15, 20, 25, 0.2);
        }
        
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .user-profile:hover {
            background: rgba(125, 211, 192, 0.1);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #7dd3c0 0%, #6eb5ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #0f1419;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-role {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: capitalize;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .topbar {
            height: 72px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            flex-shrink: 0;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(125, 211, 192, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            color: var(--text-primary);
        }
        
        .icon-btn:hover {
            background: rgba(125, 211, 192, 0.2);
            transform: scale(1.05);
        }
        
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-center;
            font-size: 24px;
        }
        
        .stat-icon.mint {
            background: rgba(125, 211, 192, 0.15);
            color: var(--mint-500);
        }
        
        .stat-icon.peach {
            background: rgba(255, 180, 162, 0.15);
            color: var(--peach-500);
        }
        
        .stat-icon.coral {
            background: rgba(255, 139, 148, 0.15);
            color: var(--coral-500);
        }
        
        .stat-icon.sky {
            background: rgba(110, 181, 255, 0.15);
            color: var(--sky-500);
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 800;
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, var(--mint-500) 0%, var(--sky-500) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #7dd3c0 0%, #6eb5ff 100%);
            color: #0f1419;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(125, 211, 192, 0.4);
        }
        
        .btn-secondary {
            background: rgba(125, 211, 192, 0.1);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: rgba(125, 211, 192, 0.2);
        }
        
        .btn-danger {
            background: rgba(255, 139, 148, 0.1);
            color: var(--coral-500);
        }
        
        .btn-danger:hover {
            background: rgba(255, 139, 148, 0.2);
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background: rgba(125, 211, 192, 0.05);
        }
        
        .urgency-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .urgency-high {
            background: rgba(255, 139, 148, 0.15);
            color: var(--coral-500);
        }
        
        .urgency-medium {
            background: rgba(255, 180, 162, 0.15);
            color: var(--peach-500);
        }
        
        .urgency-low {
            background: rgba(125, 211, 192, 0.15);
            color: var(--mint-500);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(125, 211, 192, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-primary);
        }
        
        .close-btn:hover {
            background: rgba(125, 211, 192, 0.2);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--mint-500);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-actions .btn {
            flex: 1;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            padding: 20px;
        }

        .login-box {
            background: #1a2332;
            border-radius: 20px;
            padding: 48px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(125, 211, 192, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #7dd3c0 0%, #5a8ba0 100%);
            border-radius: 16px;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .login-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: #fefbf7;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: #9ca3af;
            font-size: 14px;
        }

        .error-message {
            background: rgba(255, 139, 148, 0.1);
            border: 1px solid rgba(255, 139, 148, 0.3);
            color: #ff8b94;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-buttons .btn {
            padding: 8px 12px;
            font-size: 13px;
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: capitalize;
        }

        .role-owner {
            background: rgba(125, 211, 192, 0.15);
            color: var(--mint-500);
        }

        .role-admin {
            background: rgba(110, 181, 255, 0.15);
            color: var(--sky-500);
        }

        .role-staff {
            background: rgba(255, 180, 162, 0.15);
            color: var(--peach-500);
        }

        .invoice-section {
            background: rgba(125, 211, 192, 0.05);
            border: 1px solid rgba(125, 211, 192, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .invoice-section-header {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .invoice-section-header input,
        .invoice-section-header select {
            flex: 1;
        }

        .invoice-section-fields {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .invoice-section-fields input {
            flex: 1;
        }

        .invoice-amount {
            background: rgba(255, 180, 162, 0.1);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            color: var(--peach-500);
            white-space: nowrap;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            z-index: 999;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--mint-500);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="dark">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Configuration
        const API_URL = 'https://ticket-system-backend-a72f.onrender.com/api';

        // API Helper Functions
        const api = {
            // Get auth token
            getToken: () => localStorage.getItem('token'),
            
            // Set auth token
            setToken: (token) => localStorage.setItem('token', token),
            
            // Remove auth token
            removeToken: () => localStorage.removeItem('token'),
            
            // Make authenticated request
            request: async (endpoint, options = {}) => {
                const token = api.getToken();
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                };

                try {
                    const response = await fetch(`${API_URL}${endpoint}`, {
                        ...options,
                        headers
                    });

                    if (response.status === 401) {
                        api.removeToken();
                        window.location.reload();
                        return null;
                    }

                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Request failed');
                    }

                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },

            // Auth
            login: (username, password) => 
                api.request('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                }),

            // Tickets
            getTickets: (status) => 
                api.request(`/tickets${status ? `?status=${status}` : ''}`),
            
            createTicket: (ticket) =>
                api.request('/tickets', {
                    method: 'POST',
                    body: JSON.stringify(ticket)
                }),
            
            updateTicket: (id, ticket) =>
                api.request(`/tickets/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(ticket)
                }),
            
            completeTicket: (id, resolution) =>
                api.request(`/tickets/${id}/complete`, {
                    method: 'PUT',
                    body: JSON.stringify({ resolution })
                }),
            
            archiveTicket: (id) =>
                api.request(`/tickets/${id}/archive`, { method: 'PUT' }),
            
            unarchiveTicket: (id) =>
                api.request(`/tickets/${id}/unarchive`, { method: 'PUT' }),
            
            deleteTicket: (id) =>
                api.request(`/tickets/${id}`, { method: 'DELETE' }),

            // Invoices
            getInvoices: (status) =>
                api.request(`/invoices${status ? `?status=${status}` : ''}`),
            
            createInvoice: (invoice) =>
                api.request('/invoices', {
                    method: 'POST',
                    body: JSON.stringify(invoice)
                }),
            
            updateInvoice: (id, invoice) =>
                api.request(`/invoices/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(invoice)
                }),
            
            markInvoicePaid: (id, paid) =>
                api.request(`/invoices/${id}/pay`, {
                    method: 'PUT',
                    body: JSON.stringify({ paid })
                }),
            
            archiveInvoice: (id) =>
                api.request(`/invoices/${id}/archive`, { method: 'PUT' }),
            
            unarchiveInvoice: (id) =>
                api.request(`/invoices/${id}/unarchive`, { method: 'PUT' }),
            
            deleteInvoice: (id) =>
                api.request(`/invoices/${id}`, { method: 'DELETE' }),

            // Users
            getUsers: () => api.request('/users'),
            
            createUser: (user) =>
                api.request('/users', {
                    method: 'POST',
                    body: JSON.stringify(user)
                }),
            
            updateUser: (id, user) =>
                api.request(`/users/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(user)
                }),
            
            deleteUser: (id) =>
                api.request(`/users/${id}`, { method: 'DELETE' }),

            // Analytics
            getStats: () => api.request('/analytics/stats'),
            
            getMonthlyData: () => api.request('/analytics/monthly')
        };

        // Alert Component
        function Alert({ message, type, onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div className={`alert alert-${type}`}>
                    <span className="alert-icon">
                        {type === 'success' ? 'âœ“' : 'âœ•'}
                    </span>
                    <span className="alert-message">{message}</span>
                </div>
            );
        }

        // Loading Spinner
        function LoadingSpinner() {
            return (
                <div className="loading-overlay">
                    <div className="spinner"></div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [currentView, setCurrentView] = useState('dashboard');
            const [darkMode, setDarkMode] = useState(true);
            const [loading, setLoading] = useState(false);
            const [alert, setAlert] = useState(null);

            // Data states
            const [tickets, setTickets] = useState([]);
            const [completedTickets, setCompletedTickets] = useState([]);
            const [archivedTickets, setArchivedTickets] = useState([]);
            const [invoices, setInvoices] = useState([]);
            const [paidInvoices, setPaidInvoices] = useState([]);
            const [archivedInvoices, setArchivedInvoices] = useState([]);
            const [users, setUsers] = useState([]);
            const [stats, setStats] = useState({
                openTickets: 0,
                myTickets: 0,
                overdueTickets: 0,
                revenue: 0
            });

            // Modal states
            const [showNewTicket, setShowNewTicket] = useState(false);
            const [showEditTicket, setShowEditTicket] = useState(false);
            const [editingTicket, setEditingTicket] = useState(null);
            const [showNewInvoice, setShowNewInvoice] = useState(false);
            const [showEditInvoice, setShowEditInvoice] = useState(false);
            const [editingInvoice, setEditingInvoice] = useState(null);
            const [showAddStaff, setShowAddStaff] = useState(false);
            const [showEditUser, setShowEditUser] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [showResolution, setShowResolution] = useState(false);
            const [selectedTicket, setSelectedTicket] = useState(null);

            // Form states
            const [newTicket, setNewTicket] = useState({
                client: '', task: '', deadline: '', location: '', urgency: 'medium', assignedTo: '', description: ''
            });
            const [invoiceSections, setInvoiceSections] = useState([{ description: '', type: 'hourly', rate: '', hours: '', amount: '' }]);
            const [newInvoice, setNewInvoice] = useState({
                client: '', paymentTerms: 'now', inQuickBooks: 'no', contactName: '', contactEmail: '', contactPhone: ''
            });
            const [newStaff, setNewStaff] = useState({
                username: '', password: '', role: 'staff', firstName: '', lastName: ''
            });
            const [resolution, setResolution] = useState('');

            // Show alert
            const showAlert = (message, type = 'success') => {
                setAlert({ message, type });
            };

            // Load initial data
            const loadData = async () => {
                if (!currentUser) return;
                
                setLoading(true);
                try {
                    const [
                        activeTickets,
                        completedTicketsData,
                        archivedTicketsData,
                        activeInvoices,
                        paidInvoicesData,
                        archivedInvoicesData,
                        statsData,
                        usersData
                    ] = await Promise.all([
                        api.getTickets('active'),
                        api.getTickets('completed'),
                        api.getTickets('archived'),
                        api.getInvoices('active'),
                        api.getInvoices('paid'),
                        api.getInvoices('archived'),
                        api.getStats(),
                        currentUser.role !== 'staff' ? api.getUsers() : Promise.resolve([])
                    ]);

                    setTickets(activeTickets);
                    setCompletedTickets(completedTicketsData);
                    setArchivedTickets(archivedTicketsData);
                    setInvoices(activeInvoices);
                    setPaidInvoices(paidInvoicesData);
                    setArchivedInvoices(archivedInvoicesData);
                    setStats(statsData);
                    if (currentUser.role !== 'staff') setUsers(usersData);
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Load data on user change
            useEffect(() => {
                loadData();
            }, [currentUser]);

            // Toggle dark mode
            useEffect(() => {
                document.body.className = darkMode ? 'dark' : 'light';
            }, [darkMode]);

            // Check for existing session
            useEffect(() => {
                const token = api.getToken();
                if (token) {
                    // Token exists, verify it's valid by trying to get stats
                    api.getStats()
                        .then(() => {
                            // Token valid, decode user info (stored in token)
                            const payload = JSON.parse(atob(token.split('.')[1]));
                            setCurrentUser({
                                id: payload.id,
                                username: payload.username,
                                role: payload.role,
                                name: payload.name
                            });
                        })
                        .catch(() => {
                            api.removeToken();
                        });
                }
            }, []);

            // Create ticket
            const handleCreateTicket = async () => {
                setLoading(true);
                try {
                    await api.createTicket(newTicket);
                    showAlert('Ticket created successfully!');
                    setShowNewTicket(false);
                    setNewTicket({ client: '', task: '', deadline: '', location: '', urgency: 'medium', assignedTo: '', description: '' });
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Update ticket
            const handleUpdateTicket = async () => {
                setLoading(true);
                try {
                    await api.updateTicket(editingTicket.id, editingTicket);
                    showAlert('Ticket updated successfully!');
                    setShowEditTicket(false);
                    setEditingTicket(null);
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Complete ticket
            const handleCompleteTicket = async () => {
                setLoading(true);
                try {
                    await api.completeTicket(selectedTicket.id, resolution);
                    showAlert('Ticket completed!');
                    setShowResolution(false);
                    setResolution('');
                    setSelectedTicket(null);
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Archive ticket
            const handleArchiveTicket = async (id) => {
                setLoading(true);
                try {
                    await api.archiveTicket(id);
                    showAlert('Ticket archived!');
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Unarchive ticket
            const handleUnarchiveTicket = async (id) => {
                setLoading(true);
                try {
                    await api.unarchiveTicket(id);
                    showAlert('Ticket unarchived!');
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Delete ticket
            const handleDeleteTicket = async (id) => {
                if (!confirm('Are you sure you want to delete this ticket?')) return;
                setLoading(true);
                try {
                    await api.deleteTicket(id);
                    showAlert('Ticket deleted!');
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Create invoice
            const handleCreateInvoice = async () => {
                setLoading(true);
                try {
                    await api.createInvoice({
                        ...newInvoice,
                        sections: invoiceSections
                    });
                    showAlert('Invoice created successfully!');
                    setShowNewInvoice(false);
                    setNewInvoice({ client: '', paymentTerms: 'now', inQuickBooks: 'no', contactName: '', contactEmail: '', contactPhone: '' });
                    setInvoiceSections([{ description: '', type: 'hourly', rate: '', hours: '', amount: '' }]);
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Open edit invoice modal
            const handleEditInvoice = (invoice) => {
                setEditingInvoice(invoice);
                setInvoiceSections(invoice.sections || [{ description: '', type: 'hourly', rate: '', hours: '', amount: '' }]);
                setShowEditInvoice(true);
            };

            // Update invoice
            const handleUpdateInvoice = async () => {
                setLoading(true);
                try {
                    await api.updateInvoice(editingInvoice.id, {
                        client: editingInvoice.client,
                        paymentTerms: editingInvoice.paymentTerms,
                        inQuickBooks: editingInvoice.inQuickBooks,
                        paymentDeadline: editingInvoice.paymentDeadline,
                        contactName: editingInvoice.contactName,
                        contactEmail: editingInvoice.contactEmail,
                        contactPhone: editingInvoice.contactPhone,
                        sections: invoiceSections
                    });
                    showAlert('Invoice updated successfully!');
                    setShowEditInvoice(false);
                    setEditingInvoice(null);
                    setInvoiceSections([{ description: '', type: 'hourly', rate: '', hours: '', amount: '' }]);
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Mark invoice paid
            const handleMarkPaid = async (id, paid) => {
                setLoading(true);
                try {
                    await api.markInvoicePaid(id, paid);
                    showAlert(paid ? 'Invoice marked as paid!' : 'Invoice marked as unpaid!');
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Archive invoice
            const handleArchiveInvoice = async (id) => {
                setLoading(true);
                try {
                    await api.archiveInvoice(id);
                    showAlert('Invoice archived!');
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Unarchive invoice
            const handleUnarchiveInvoice = async (id) => {
                setLoading(true);
                try {
                    await api.unarchiveInvoice(id);
                    showAlert('Invoice unarchived!');
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Delete invoice
            const handleDeleteInvoice = async (id) => {
                if (!confirm('Are you sure you want to delete this invoice?')) return;
                setLoading(true);
                try {
                    await api.deleteInvoice(id);
                    showAlert('Invoice deleted!');
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Create user
            const handleCreateUser = async () => {
                setLoading(true);
                try {
                    await api.createUser(newStaff);
                    showAlert('User created successfully!');
                    setShowAddStaff(false);
                    setNewStaff({ username: '', password: '', role: 'staff', firstName: '', lastName: '' });
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Update user
            const handleUpdateUser = async () => {
                setLoading(true);
                try {
                    await api.updateUser(editingUser.id, editingUser);
                    showAlert('User updated successfully!');
                    setShowEditUser(false);
                    setEditingUser(null);
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Delete user
            const handleDeleteUser = async (id, username) => {
                if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) return;
                setLoading(true);
                try {
                    await api.deleteUser(id);
                    showAlert('User deleted successfully!');
                    loadData();
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Calculate invoice total
            const calculateInvoiceTotal = () => {
                return invoiceSections.reduce((sum, section) => {
                    if (section.type === 'hourly') {
                        return sum + (parseFloat(section.rate) || 0) * (parseFloat(section.hours) || 0);
                    } else {
                        return sum + (parseFloat(section.amount) || 0);
                    }
                }, 0);
            };

            // Add invoice section
            const addInvoiceSection = () => {
                setInvoiceSections([...invoiceSections, { description: '', type: 'hourly', rate: '', hours: '', amount: '' }]);
            };

            // Remove invoice section
            const removeInvoiceSection = (index) => {
                setInvoiceSections(invoiceSections.filter((_, i) => i !== index));
            };

            // Update invoice section
            const updateInvoiceSection = (index, field, value) => {
                const updated = [...invoiceSections];
                updated[index][field] = value;
                setInvoiceSections(updated);
            };

            // Login
            const handleLogin = async (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;

                setLoading(true);
                try {
                    const data = await api.login(username, password);
                    api.setToken(data.token);
                    setCurrentUser(data.user);
                    showAlert('Welcome back!');
                } catch (error) {
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Logout
            const handleLogout = () => {
                api.removeToken();
                setCurrentUser(null);
                showAlert('Logged out successfully!');
            };

            // Login screen
            if (!currentUser) {
                return (
                    <>
                        {loading && <LoadingSpinner />}
                        {alert && <Alert message={alert.message} type={alert.type} onClose={() => setAlert(null)} />}
                        <div className="login-container">
                            <div className="login-box">
                                <div className="login-logo">
                                    <div className="login-logo-icon">âš¡</div>
                                    <div className="login-title">Genius Tech</div>
                                    <div className="login-subtitle">Ticketing System</div>
                                </div>
                                <form onSubmit={handleLogin}>
                                    <div className="form-group">
                                        <label>Username</label>
                                        <input type="text" name="username" required autoFocus />
                                    </div>
                                    <div className="form-group">
                                        <label>Password</label>
                                        <input type="password" name="password" required />
                                    </div>
                                    <button type="submit" className="btn btn-primary" style={{width: '100%'}}>
                                        Sign In
                                    </button>
                                </form>
                                <div className="connection-status" style={{position: 'static', marginTop: '20px', justifyContent: 'center'}}>
                                    <span className="status-dot"></span>
                                    <span>Connected to Cloud</span>
                                </div>
                            </div>
                        </div>
                    </>
                );
            }

            // My Tickets view
            const myTickets = tickets.filter(t => t.assignedTo === currentUser.id);

            // Main app
            return (
                <>
                    {loading && <LoadingSpinner />}
                    {alert && <Alert message={alert.message} type={alert.type} onClose={() => setAlert(null)} />}
                    
                    <div className="app-container">
                        {/* Sidebar */}
                        <div className="sidebar">
                            <div className="sidebar-header">
                                <div className="logo">
                                    <div className="logo-icon">âš¡</div>
                                    <div className="logo-text">Genius Tech</div>
                                </div>
                            </div>
                            
                            <div className="nav">
                                <div className={`nav-item ${currentView === 'dashboard' ? 'active' : ''}`} onClick={() => setCurrentView('dashboard')}>
                                    <span className="nav-icon">ðŸ“Š</span>
                                    <span>Dashboard</span>
                                </div>
                                <div className={`nav-item ${currentView === 'tickets' ? 'active' : ''}`} onClick={() => setCurrentView('tickets')}>
                                    <span className="nav-icon">ðŸŽ«</span>
                                    <span>Active Tickets</span>
                                    <span className="badge">{tickets.length}</span>
                                </div>
                                <div className={`nav-item ${currentView === 'mytickets' ? 'active' : ''}`} onClick={() => setCurrentView('mytickets')}>
                                    <span className="nav-icon">ðŸ‘¤</span>
                                    <span>My Tickets</span>
                                    <span className="badge">{myTickets.length}</span>
                                </div>
                                <div className={`nav-item ${currentView === 'completed' ? 'active' : ''}`} onClick={() => setCurrentView('completed')}>
                                    <span className="nav-icon">âœ…</span>
                                    <span>Completed</span>
                                    <span className="badge">{completedTickets.length}</span>
                                </div>
                                <div className={`nav-item ${currentView === 'invoices' ? 'active' : ''}`} onClick={() => setCurrentView('invoices')}>
                                    <span className="nav-icon">ðŸ’°</span>
                                    <span>Invoices</span>
                                    <span className="badge">{invoices.length}</span>
                                </div>
                                <div className={`nav-item ${currentView === 'paid' ? 'active' : ''}`} onClick={() => setCurrentView('paid')}>
                                    <span className="nav-icon">ðŸ’³</span>
                                    <span>Paid</span>
                                    <span className="badge">{paidInvoices.length}</span>
                                </div>
                                {currentUser.role !== 'staff' && (
                                    <div className={`nav-item ${currentView === 'users' ? 'active' : ''}`} onClick={() => setCurrentView('users')}>
                                        <span className="nav-icon">ðŸ‘¥</span>
                                        <span>Users</span>
                                        <span className="badge">{users.length}</span>
                                    </div>
                                )}
                                <div className={`nav-item ${currentView === 'archived' ? 'active' : ''}`} onClick={() => setCurrentView('archived')}>
                                    <span className="nav-icon">ðŸ“¦</span>
                                    <span>Archived</span>
                                </div>
                            </div>
                            
                            <div className="sidebar-footer">
                                <div className="user-profile" onClick={handleLogout}>
                                    <div className="user-avatar">{currentUser.name.charAt(0)}</div>
                                    <div className="user-info">
                                        <div className="user-name">{currentUser.name}</div>
                                        <div className="user-role">{currentUser.role}</div>
                                    </div>
                                    <span>ðŸšª</span>
                                </div>
                            </div>
                        </div>

                        {/* Main Content */}
                        <div className="main-content">
                            <div className="topbar">
                                <div className="page-title">
                                    {currentView === 'dashboard' && 'Dashboard'}
                                    {currentView === 'tickets' && 'Active Tickets'}
                                    {currentView === 'mytickets' && 'My Tickets'}
                                    {currentView === 'completed' && 'Completed Tickets'}
                                    {currentView === 'invoices' && 'Invoices'}
                                    {currentView === 'paid' && 'Paid Invoices'}
                                    {currentView === 'users' && 'User Management'}
                                    {currentView === 'archived' && 'Archived Items'}
                                </div>
                                <div className="topbar-actions">
                                    <button className="icon-btn" onClick={() => setDarkMode(!darkMode)}>
                                        {darkMode ? 'â˜€ï¸' : 'ðŸŒ™'}
                                    </button>
                                </div>
                            </div>

                            <div className="content-area">
                                {/* Dashboard View */}
                                {currentView === 'dashboard' && (
                                    <>
                                        <div className="stats-grid">
                                            <div className="stat-card">
                                                <div className="stat-header">
                                                    <div>
                                                        <div className="stat-label">Open Tickets</div>
                                                        <div className="stat-value">{stats.openTickets}</div>
                                                    </div>
                                                    <div className="stat-icon mint">ðŸŽ«</div>
                                                </div>
                                            </div>
                                            <div className="stat-card">
                                                <div className="stat-header">
                                                    <div>
                                                        <div className="stat-label">My Tickets</div>
                                                        <div className="stat-value">{stats.myTickets}</div>
                                                    </div>
                                                    <div className="stat-icon peach">ðŸ‘¤</div>
                                                </div>
                                            </div>
                                            <div className="stat-card">
                                                <div className="stat-header">
                                                    <div>
                                                        <div className="stat-label">Overdue</div>
                                                        <div className="stat-value">{stats.overdueTickets}</div>
                                                    </div>
                                                    <div className="stat-icon coral">âš ï¸</div>
                                                </div>
                                            </div>
                                            <div className="stat-card">
                                                <div className="stat-header">
                                                    <div>
                                                        <div className="stat-label">Revenue</div>
                                                        <div className="stat-value">Â£{stats.revenue.toFixed(2)}</div>
                                                    </div>
                                                    <div className="stat-icon sky">ðŸ’°</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="card">
                                            <div className="card-header">
                                                <div className="card-title">Recent Activity</div>
                                            </div>
                                            <p style={{color: 'var(--text-secondary)'}}>Dashboard charts coming soon...</p>
                                        </div>
                                    </>
                                )}

                                {/* Tickets View */}
                                {currentView === 'tickets' && (
                                    <div className="card">
                                        <div className="card-header">
                                            <div className="card-title">Active Tickets</div>
                                            <button className="btn btn-primary" onClick={() => setShowNewTicket(true)}>
                                                + New Ticket
                                            </button>
                                        </div>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Client</th>
                                                    <th>Task</th>
                                                    <th>Deadline</th>
                                                    <th>Urgency</th>
                                                    <th>Assigned To</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {tickets.map(ticket => (
                                                    <tr key={ticket.id}>
                                                        <td>{ticket.client}</td>
                                                        <td>{ticket.task}</td>
                                                        <td>{ticket.deadline}</td>
                                                        <td>
                                                            <span className={`urgency-badge urgency-${ticket.urgency}`}>
                                                                {ticket.urgency}
                                                            </span>
                                                        </td>
                                                        <td>{ticket.assignedToName || 'Unassigned'}</td>
                                                        <td>
                                                            <div className="action-buttons">
                                                                <button className="btn btn-secondary" onClick={() => { setEditingTicket(ticket); setShowEditTicket(true); }}>
                                                                    âœï¸ Edit
                                                                </button>
                                                                <button className="btn btn-secondary" onClick={() => { setSelectedTicket(ticket); setShowResolution(true); }}>
                                                                    âœ“ Complete
                                                                </button>
                                                                <button className="btn btn-secondary" onClick={() => handleArchiveTicket(ticket.id)}>
                                                                    ðŸ“¦ Archive
                                                                </button>
                                                                <button className="btn btn-danger" onClick={() => handleDeleteTicket(ticket.id)}>
                                                                    ðŸ—‘ï¸ Delete
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {/* My Tickets View */}
                                {currentView === 'mytickets' && (
                                    <div className="card">
                                        <div className="card-header">
                                            <div className="card-title">My Tickets</div>
                                        </div>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Client</th>
                                                    <th>Task</th>
                                                    <th>Deadline</th>
                                                    <th>Urgency</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {myTickets.map(ticket => (
                                                    <tr key={ticket.id}>
                                                        <td>{ticket.client}</td>
                                                        <td>{ticket.task}</td>
                                                        <td>{ticket.deadline}</td>
                                                        <td>
                                                            <span className={`urgency-badge urgency-${ticket.urgency}`}>
                                                                {ticket.urgency}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div className="action-buttons">
                                                                <button className="btn btn-secondary" onClick={() => { setEditingTicket(ticket); setShowEditTicket(true); }}>
                                                                    âœï¸ Edit
                                                                </button>
                                                                <button className="btn btn-secondary" onClick={() => { setSelectedTicket(ticket); setShowResolution(true); }}>
                                                                    âœ“ Complete
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {/* Completed View */}
                                {currentView === 'completed' && (
                                    <div className="card">
                                        <div className="card-header">
                                            <div className="card-title">Completed Tickets</div>
                                        </div>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Client</th>
                                                    <th>Task</th>
                                                    <th>Resolution</th>
                                                    <th>Completed</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {completedTickets.map(ticket => (
                                                    <tr key={ticket.id}>
                                                        <td>{ticket.client}</td>
                                                        <td>{ticket.task}</td>
                                                        <td>{ticket.resolution}</td>
                                                        <td>{new Date(ticket.completedDate).toLocaleDateString()}</td>
                                                        <td>
                                                            <div className="action-buttons">
                                                                <button className="btn btn-secondary" onClick={() => handleArchiveTicket(ticket.id)}>
                                                                    ðŸ“¦ Archive
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {/* Invoices View */}
                                {currentView === 'invoices' && (
                                    <div className="card">
                                        <div className="card-header">
                                            <div className="card-title">Active Invoices</div>
                                            <button className="btn btn-primary" onClick={() => setShowNewInvoice(true)}>
                                                + New Invoice
                                            </button>
                                        </div>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Client</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                    <th>Payment Terms</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {invoices.map(invoice => (
                                                    <tr key={invoice.id}>
                                                        <td>{invoice.client}</td>
                                                        <td>Â£{invoice.totalAmount.toFixed(2)}</td>
                                                        <td>{new Date(invoice.date).toLocaleDateString()}</td>
                                                        <td>{invoice.paymentTerms.replace('_', ' ')}</td>
                                                        <td>
                                                            <div className="action-buttons">
                                                                <button className="btn btn-secondary" onClick={() => handleEditInvoice(invoice)}>
                                                                    âœï¸ Edit
                                                                </button>
                                                                <button className="btn btn-primary" onClick={() => handleMarkPaid(invoice.id, true)}>
                                                                    ðŸ’³ Mark Paid
                                                                </button>
                                                                <button className="btn btn-secondary" onClick={() => handleArchiveInvoice(invoice.id)}>
                                                                    ðŸ“¦ Archive
                                                                </button>
                                                                <button className="btn btn-danger" onClick={() => handleDeleteInvoice(invoice.id)}>
                                                                    ðŸ—‘ï¸ Delete
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {/* Paid View */}
                                {currentView === 'paid' && (
                                    <div className="card">
                                        <div className="card-header">
                                            <div className="card-title">Paid Invoices</div>
                                        </div>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Client</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                    <th>Paid Date</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {paidInvoices.map(invoice => (
                                                    <tr key={invoice.id}>
                                                        <td>{invoice.client}</td>
                                                        <td>Â£{invoice.totalAmount.toFixed(2)}</td>
                                                        <td>{new Date(invoice.date).toLocaleDateString()}</td>
                                                        <td>{new Date(invoice.paidDate).toLocaleDateString()}</td>
                                                        <td>
                                                            <div className="action-buttons">
                                                                <button className="btn btn-secondary" onClick={() => handleArchiveInvoice(invoice.id)}>
                                                                    ðŸ“¦ Archive
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {/* Users View */}
                                {currentView === 'users' && currentUser.role !== 'staff' && (
                                    <div className="card">
                                        <div className="card-header">
                                            <div className="card-title">User Management</div>
                                            <button className="btn btn-primary" onClick={() => setShowAddStaff(true)}>
                                                + Add User
                                            </button>
                                        </div>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Username</th>
                                                    <th>Role</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {users.map(user => (
                                                    <tr key={user.id}>
                                                        <td>{user.name}</td>
                                                        <td>{user.username}</td>
                                                        <td>
                                                            <span className={`role-badge role-${user.role}`}>
                                                                {user.role}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div className="action-buttons">
                                                                <button className="btn btn-secondary" onClick={() => { setEditingUser(user); setShowEditUser(true); }}>
                                                                    âœï¸ Edit
                                                                </button>
                                                                {currentUser.role === 'owner' && user.id !== currentUser.id && (
                                                                    <button className="btn btn-danger" onClick={() => handleDeleteUser(user.id, user.username)}>
                                                                        ðŸ—‘ï¸ Delete
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {/* Archived View */}
                                {currentView === 'archived' && (
                                    <>
                                        <div className="card" style={{marginBottom: '24px'}}>
                                            <div className="card-header">
                                                <div className="card-title">Archived Tickets</div>
                                            </div>
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Client</th>
                                                        <th>Task</th>
                                                        <th>Archived Date</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {archivedTickets.map(ticket => (
                                                        <tr key={ticket.id}>
                                                            <td>{ticket.client}</td>
                                                            <td>{ticket.task}</td>
                                                            <td>{new Date(ticket.archivedDate).toLocaleDateString()}</td>
                                                            <td>
                                                                <button className="btn btn-secondary" onClick={() => handleUnarchiveTicket(ticket.id)}>
                                                                    â†©ï¸ Unarchive
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div className="card">
                                            <div className="card-header">
                                                <div className="card-title">Archived Invoices</div>
                                            </div>
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Client</th>
                                                        <th>Amount</th>
                                                        <th>Archived Date</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {archivedInvoices.map(invoice => (
                                                        <tr key={invoice.id}>
                                                            <td>{invoice.client}</td>
                                                            <td>Â£{invoice.totalAmount.toFixed(2)}</td>
                                                            <td>{new Date(invoice.archivedDate).toLocaleDateString()}</td>
                                                            <td>
                                                                <button className="btn btn-secondary" onClick={() => handleUnarchiveInvoice(invoice.id)}>
                                                                    â†©ï¸ Unarchive
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* New Ticket Modal */}
                    {showNewTicket && (
                        <div className="modal-overlay" onClick={() => setShowNewTicket(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <div className="modal-title">New Ticket</div>
                                    <button className="close-btn" onClick={() => setShowNewTicket(false)}>âœ•</button>
                                </div>
                                <div className="form-group">
                                    <label>Client Name *</label>
                                    <input value={newTicket.client} onChange={e => setNewTicket({...newTicket, client: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Task Description *</label>
                                    <input value={newTicket.task} onChange={e => setNewTicket({...newTicket, task: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Deadline *</label>
                                    <input type="date" value={newTicket.deadline} onChange={e => setNewTicket({...newTicket, deadline: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Location</label>
                                    <input value={newTicket.location} onChange={e => setNewTicket({...newTicket, location: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Urgency *</label>
                                    <select value={newTicket.urgency} onChange={e => setNewTicket({...newTicket, urgency: e.target.value})}>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Assign To</label>
                                    <select value={newTicket.assignedTo} onChange={e => setNewTicket({...newTicket, assignedTo: e.target.value})}>
                                        <option value="">Unassigned</option>
                                        {users.filter(u => u.role === 'staff' || u.role === 'admin').map(u => (
                                            <option key={u.id} value={u.id}>{u.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Description</label>
                                    <textarea value={newTicket.description} onChange={e => setNewTicket({...newTicket, description: e.target.value})} />
                                </div>
                                <div className="modal-actions">
                                    <button className="btn btn-secondary" onClick={() => setShowNewTicket(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleCreateTicket}>Create Ticket</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Ticket Modal */}
                    {showEditTicket && editingTicket && (
                        <div className="modal-overlay" onClick={() => setShowEditTicket(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <div className="modal-title">Edit Ticket</div>
                                    <button className="close-btn" onClick={() => setShowEditTicket(false)}>âœ•</button>
                                </div>
                                <div className="form-group">
                                    <label>Client Name *</label>
                                    <input value={editingTicket.client} onChange={e => setEditingTicket({...editingTicket, client: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Task Description *</label>
                                    <input value={editingTicket.task} onChange={e => setEditingTicket({...editingTicket, task: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Deadline *</label>
                                    <input type="date" value={editingTicket.deadline} onChange={e => setEditingTicket({...editingTicket, deadline: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Location</label>
                                    <input value={editingTicket.location || ''} onChange={e => setEditingTicket({...editingTicket, location: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Urgency *</label>
                                    <select value={editingTicket.urgency} onChange={e => setEditingTicket({...editingTicket, urgency: e.target.value})}>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Assign To</label>
                                    <select value={editingTicket.assignedTo || ''} onChange={e => setEditingTicket({...editingTicket, assignedTo: e.target.value})}>
                                        <option value="">Unassigned</option>
                                        {users.filter(u => u.role === 'staff' || u.role === 'admin').map(u => (
                                            <option key={u.id} value={u.id}>{u.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Description</label>
                                    <textarea value={editingTicket.description || ''} onChange={e => setEditingTicket({...editingTicket, description: e.target.value})} />
                                </div>
                                <div className="modal-actions">
                                    <button className="btn btn-secondary" onClick={() => setShowEditTicket(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleUpdateTicket}>Update Ticket</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Resolution Modal */}
                    {showResolution && selectedTicket && (
                        <div className="modal-overlay" onClick={() => setShowResolution(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <div className="modal-title">Complete Ticket</div>
                                    <button className="close-btn" onClick={() => setShowResolution(false)}>âœ•</button>
                                </div>
                                <p><strong>Client:</strong> {selectedTicket.client}</p>
                                <p><strong>Task:</strong> {selectedTicket.task}</p>
                                <div className="form-group">
                                    <label>Resolution *</label>
                                    <textarea value={resolution} onChange={e => setResolution(e.target.value)} placeholder="Describe how this ticket was resolved..." />
                                </div>
                                <div className="modal-actions">
                                    <button className="btn btn-secondary" onClick={() => setShowResolution(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleCompleteTicket}>Complete</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* New Invoice Modal */}
                    {showNewInvoice && (
                        <div className="modal-overlay" onClick={() => setShowNewInvoice(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <div className="modal-title">New Invoice</div>
                                    <button className="close-btn" onClick={() => setShowNewInvoice(false)}>âœ•</button>
                                </div>
                                <div className="form-group">
                                    <label>Client Name *</label>
                                    <input value={newInvoice.client} onChange={e => setNewInvoice({...newInvoice, client: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Payment Terms</label>
                                    <select value={newInvoice.paymentTerms} onChange={e => setNewInvoice({...newInvoice, paymentTerms: e.target.value})}>
                                        <option value="now">Now</option>
                                        <option value="end_of_month">End of Month</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>In QuickBooks?</label>
                                    <select value={newInvoice.inQuickBooks} onChange={e => setNewInvoice({...newInvoice, inQuickBooks: e.target.value})}>
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Contact Name</label>
                                    <input value={newInvoice.contactName} onChange={e => setNewInvoice({...newInvoice, contactName: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Contact Email</label>
                                    <input type="email" value={newInvoice.contactEmail} onChange={e => setNewInvoice({...newInvoice, contactEmail: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Contact Phone</label>
                                    <input value={newInvoice.contactPhone} onChange={e => setNewInvoice({...newInvoice, contactPhone: e.target.value})} />
                                </div>
                                
                                <div style={{marginTop: '24px'}}>
                                    <label style={{marginBottom: '12px', display: 'block'}}>Invoice Items *</label>
                                    {invoiceSections.map((section, index) => (
                                        <div key={index} className="invoice-section">
                                            <div className="invoice-section-header">
                                                <input 
                                                    placeholder="Description"
                                                    value={section.description}
                                                    onChange={e => updateInvoiceSection(index, 'description', e.target.value)}
                                                />
                                                <select
                                                    value={section.type}
                                                    onChange={e => updateInvoiceSection(index, 'type', e.target.value)}
                                                >
                                                    <option value="hourly">Hourly Rate</option>
                                                    <option value="fixed">Fixed Charge</option>
                                                </select>
                                                {invoiceSections.length > 1 && (
                                                    <button className="btn btn-danger" onClick={() => removeInvoiceSection(index)}>âœ•</button>
                                                )}
                                            </div>
                                            <div className="invoice-section-fields">
                                                {section.type === 'hourly' ? (
                                                    <>
                                                        <input
                                                            type="number"
                                                            placeholder="Rate (Â£/hr)"
                                                            value={section.rate}
                                                            onChange={e => updateInvoiceSection(index, 'rate', e.target.value)}
                                                        />
                                                        <span>Ã—</span>
                                                        <input
                                                            type="number"
                                                            placeholder="Hours"
                                                            value={section.hours}
                                                            onChange={e => updateInvoiceSection(index, 'hours', e.target.value)}
                                                        />
                                                        <span>=</span>
                                                        <div className="invoice-amount">
                                                            Â£{((parseFloat(section.rate) || 0) * (parseFloat(section.hours) || 0)).toFixed(2)}
                                                        </div>
                                                    </>
                                                ) : (
                                                    <>
                                                        <input
                                                            type="number"
                                                            placeholder="Amount (Â£)"
                                                            value={section.amount}
                                                            onChange={e => updateInvoiceSection(index, 'amount', e.target.value)}
                                                            style={{flex: 2}}
                                                        />
                                                        <div className="invoice-amount">
                                                            Â£{(parseFloat(section.amount) || 0).toFixed(2)}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    <button className="btn btn-secondary" onClick={addInvoiceSection} style={{marginTop: '12px'}}>
                                        + Add Section
                                    </button>
                                </div>

                                <div style={{marginTop: '24px', padding: '16px', background: 'rgba(125, 211, 192, 0.1)', borderRadius: '12px'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <div style={{fontSize: '20px', fontWeight: '700'}}>Total</div>
                                        <div style={{fontSize: '24px', fontWeight: '800', color: 'var(--mint-500)'}}>
                                            Â£{calculateInvoiceTotal().toFixed(2)}
                                        </div>
                                    </div>
                                </div>

                                <div className="modal-actions">
                                    <button className="btn btn-secondary" onClick={() => setShowNewInvoice(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleCreateInvoice}>Create Invoice</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Invoice Modal */}
                    {showEditInvoice && editingInvoice && (
                        <div className="modal-overlay" onClick={() => setShowEditInvoice(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <div className="modal-title">Edit Invoice</div>
                                    <button className="close-btn" onClick={() => setShowEditInvoice(false)}>âœ•</button>
                                </div>
                                <div className="form-group">
                                    <label>Client Name *</label>
                                    <input value={editingInvoice.client} onChange={e => setEditingInvoice({...editingInvoice, client: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Payment Terms</label>
                                    <select value={editingInvoice.paymentTerms} onChange={e => setEditingInvoice({...editingInvoice, paymentTerms: e.target.value})}>
                                        <option value="now">Now</option>
                                        <option value="end_of_month">End of Month</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>In QuickBooks?</label>
                                    <select value={editingInvoice.inQuickBooks} onChange={e => setEditingInvoice({...editingInvoice, inQuickBooks: e.target.value})}>
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Contact Name</label>
                                    <input value={editingInvoice.contactName || ''} onChange={e => setEditingInvoice({...editingInvoice, contactName: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Contact Email</label>
                                    <input type="email" value={editingInvoice.contactEmail || ''} onChange={e => setEditingInvoice({...editingInvoice, contactEmail: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Contact Phone</label>
                                    <input value={editingInvoice.contactPhone || ''} onChange={e => setEditingInvoice({...editingInvoice, contactPhone: e.target.value})} />
                                </div>
                                
                                <div style={{marginTop: '24px'}}>
                                    <label style={{marginBottom: '12px', display: 'block'}}>Invoice Items *</label>
                                    {invoiceSections.map((section, index) => (
                                        <div key={index} className="invoice-section">
                                            <div className="invoice-section-header">
                                                <input 
                                                    placeholder="Description"
                                                    value={section.description}
                                                    onChange={e => updateInvoiceSection(index, 'description', e.target.value)}
                                                />
                                                <select
                                                    value={section.type}
                                                    onChange={e => updateInvoiceSection(index, 'type', e.target.value)}
                                                >
                                                    <option value="hourly">Hourly Rate</option>
                                                    <option value="fixed">Fixed Charge</option>
                                                </select>
                                                {invoiceSections.length > 1 && (
                                                    <button className="btn btn-danger" onClick={() => removeInvoiceSection(index)}>âœ•</button>
                                                )}
                                            </div>
                                            <div className="invoice-section-fields">
                                                {section.type === 'hourly' ? (
                                                    <>
                                                        <input
                                                            type="number"
                                                            placeholder="Rate (Â£/hr)"
                                                            value={section.rate || ''}
                                                            onChange={e => updateInvoiceSection(index, 'rate', e.target.value)}
                                                        />
                                                        <span>Ã—</span>
                                                        <input
                                                            type="number"
                                                            placeholder="Hours"
                                                            value={section.hours || ''}
                                                            onChange={e => updateInvoiceSection(index, 'hours', e.target.value)}
                                                        />
                                                        <span>=</span>
                                                        <div className="invoice-amount">
                                                            Â£{((parseFloat(section.rate) || 0) * (parseFloat(section.hours) || 0)).toFixed(2)}
                                                        </div>
                                                    </>
                                                ) : (
                                                    <>
                                                        <input
                                                            type="number"
                                                            placeholder="Amount (Â£)"
                                                            value={section.amount || ''}
                                                            onChange={e => updateInvoiceSection(index, 'amount', e.target.value)}
                                                            style={{flex: 2}}
                                                        />
                                                        <div className="invoice-amount">
                                                            Â£{(parseFloat(section.amount) || 0).toFixed(2)}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    <button className="btn btn-secondary" onClick={addInvoiceSection} style={{marginTop: '12px'}}>
                                        + Add Section
                                    </button>
                                </div>

                                <div style={{marginTop: '24px', padding: '16px', background: 'rgba(125, 211, 192, 0.1)', borderRadius: '12px'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <div style={{fontSize: '20px', fontWeight: '700'}}>Total</div>
                                        <div style={{fontSize: '24px', fontWeight: '800', color: 'var(--mint-500)'}}>
                                            Â£{calculateInvoiceTotal().toFixed(2)}
                                        </div>
                                    </div>
                                </div>

                                <div className="modal-actions">
                                    <button className="btn btn-secondary" onClick={() => setShowEditInvoice(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleUpdateInvoice}>Update Invoice</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add User Modal */}
                    {showAddStaff && (
                        <div className="modal-overlay" onClick={() => setShowAddStaff(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <div className="modal-title">Add User</div>
                                    <button className="close-btn" onClick={() => setShowAddStaff(false)}>âœ•</button>
                                </div>
                                <div className="form-group">
                                    <label>Username *</label>
                                    <input value={newStaff.username} onChange={e => setNewStaff({...newStaff, username: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Password *</label>
                                    <input type="password" value={newStaff.password} onChange={e => setNewStaff({...newStaff, password: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>First Name *</label>
                                    <input value={newStaff.firstName} onChange={e => setNewStaff({...newStaff, firstName: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Last Name *</label>
                                    <input value={newStaff.lastName} onChange={e => setNewStaff({...newStaff, lastName: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Role *</label>
                                    <select value={newStaff.role} onChange={e => setNewStaff({...newStaff, role: e.target.value})}>
                                        <option value="staff">Staff</option>
                                        <option value="admin">Admin</option>
                                        {currentUser.role === 'owner' && <option value="owner">Owner</option>}
                                    </select>
                                </div>
                                <div className="modal-actions">
                                    <button className="btn btn-secondary" onClick={() => setShowAddStaff(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleCreateUser}>Add User</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit User Modal */}
                    {showEditUser && editingUser && (
                        <div className="modal-overlay" onClick={() => setShowEditUser(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <div className="modal-title">Edit User</div>
                                    <button className="close-btn" onClick={() => setShowEditUser(false)}>âœ•</button>
                                </div>
                                <div className="form-group">
                                    <label>Username</label>
                                    <input value={editingUser.username} onChange={e => setEditingUser({...editingUser, username: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>New Password (leave blank to keep current)</label>
                                    <input type="password" placeholder="Enter new password" onChange={e => setEditingUser({...editingUser, password: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>First Name</label>
                                    <input value={editingUser.firstName} onChange={e => setEditingUser({...editingUser, firstName: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Last Name</label>
                                    <input value={editingUser.lastName} onChange={e => setEditingUser({...editingUser, lastName: e.target.value})} />
                                </div>
                                <div className="modal-actions">
                                    <button className="btn btn-secondary" onClick={() => setShowEditUser(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleUpdateUser}>Update User</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="connection-status">
                        <span className="status-dot"></span>
                        <span>Connected to Cloud</span>
                    </div>
                </>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
